<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🎥 TCLDCAM - 智能偵測</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; padding: 10px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; padding: 20px 0; }
        .logo { font-size: 3em; margin-bottom: 10px; }
        .title { font-size: 2em; margin-bottom: 10px; }
        .nav { display: flex; background: rgba(255,255,255,0.1); border-radius: 25px; padding: 5px; margin: 20px 0; }
        .nav-item { flex: 1; text-align: center; padding: 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; }
        .nav-item.active { background: rgba(255,255,255,0.2); }
        .content { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; min-height: 300px; }
        .btn { background: #ff6b6b; border: none; border-radius: 25px; padding: 15px 30px; color: white; cursor: pointer; font-size: 1.1em; margin: 10px; }
        .btn:hover { background: #ff5252; }
        .btn.active { background: #ff4757; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .status { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin: 15px 0; }
        .row { display: flex; justify-content: space-between; margin: 8px 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .card { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; text-align: center; }
        .icon { font-size: 2em; display: block; margin-bottom: 10px; }
        .hidden { display: none; }
        
        /* 手機版優化 */
        @media (max-width: 768px) {
            .container { padding: 5px; }
            .header { padding: 15px 0; }
            .logo { font-size: 2.5em; }
            .title { font-size: 1.8em; }
            .nav { flex-direction: column; padding: 3px; }
            .nav-item { margin: 3px 0; padding: 15px; font-size: 1em; }
            .content { padding: 15px; min-height: 250px; }
            .btn { padding: 12px 25px; font-size: 1em; margin: 8px; }
            .status { padding: 12px; }
            .row { flex-direction: column; text-align: center; margin: 12px 0; }
            .grid { grid-template-columns: 1fr; gap: 10px; }
            .card { padding: 15px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 3px; }
            .header { padding: 10px 0; }
            .logo { font-size: 2em; }
            .title { font-size: 1.5em; }
            .nav-item { padding: 12px; font-size: 0.9em; }
            .content { padding: 10px; }
            .btn { padding: 10px 20px; font-size: 0.9em; }
            .card { padding: 12px; }
        }
        
        /* 觸控優化 */
        .nav-item, .btn {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* 防止縮放 */
        input[type="range"], input[type="checkbox"], select {
            -webkit-appearance: none;
            touch-action: manipulation;
        }
        
        input[type="range"] {
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #ff6b6b;
            cursor: pointer;
            border: 2px solid white;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 4px;
            position: relative;
        }
        
        input[type="checkbox"]:checked {
            background: #27ae60;
        }
        
        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: -2px;
            left: 2px;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        select {
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            font-size: 16px; /* 防止iOS縮放 */
        }
        
        select option {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">🎥</div>
            <h1 class="title">TCLDCAM</h1>
            <p>智能聲音與視覺偵測</p>
        </div>
        
        <div class="nav">
            <div class="nav-item active" onclick="show('home')">🏠 主頁</div>
            <div class="nav-item" onclick="show('settings')">⚙️ 設定</div>
            <div class="nav-item" onclick="show('files')">📁 檔案</div>
            <div class="nav-item" onclick="show('models')">🤖 模型</div>
        </div>
        
        <div id="home" class="content">
            <h2 style="text-align: center; margin-bottom: 20px;">🎯 偵測控制</h2>
            <div style="text-align: center;">
                <button id="recordBtn" class="btn" onclick="toggle()">🎬 開始錄影偵測</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button id="testRecordBtn" class="btn" onclick="testRecording()" style="background: #27ae60; font-size: 0.9em; padding: 12px 20px;">🧪 測試錄製</button>
                <button id="testTriggerBtn" class="btn" onclick="testTrigger()" style="background: #3742fa; font-size: 0.9em; padding: 12px 20px;">🔥 測試觸發</button>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <button id="diagnoseMacBtn" class="btn" onclick="diagnoseMacOS()" style="background: #e67e22; font-size: 0.9em; padding: 12px 20px;">🍎 診斷</button>
                <button id="forceAudioBtn" class="btn" onclick="forceAudioTest()" style="background: #8e44ad; font-size: 0.9em; padding: 12px 20px;">⚡ 強制測試</button>
            </div>
            
            <div class="status">
                <div class="row"><span>📊 狀態:</span><span id="status">待機中</span></div>
                <div class="row"><span>🎵 音量:</span><span id="volume">0 dB</span></div>
                <div class="row"><span>👁️ 視覺:</span><span id="visual">未啟動</span></div>
                <div class="row"><span>⏱️ 時間:</span><span id="time">00:00</span></div>
                <div class="row"><span>🔍 實時:</span><span id="debug">點擊開始偵測測試麥克風</span></div>
                <div class="row"><span>🎯 閾值:</span><span id="thresholdDisplay">15 dB</span></div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <span class="icon">🎵</span>
                    <h3>聲音偵測</h3>
                    <p>智能識別特定聲音模式</p>
                </div>
                <div class="card">
                    <span class="icon">👁️</span>
                    <h3>視覺偵測</h3>
                    <p>AI驅動的畫面分析</p>
                </div>
                <div class="card">
                    <span class="icon">📹</span>
                    <h3>自動錄製</h3>
                    <p>偵測到目標時自動錄製</p>
                </div>
                <div class="card">
                    <span class="icon">🤖</span>
                    <h3>AI模型</h3>
                    <p>雲端更新與本地緩存</p>
                </div>
            </div>
        </div>
        
        <div id="settings" class="content hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">⚙️ 偵測設定</h2>
            <div class="status">
                <h3>🎵 聲音偵測設定</h3>
                <div class="row"><span>偵測閾值:</span><span id="audioThresholdValue">15 dB</span></div>
                <input type="range" id="audioThresholdSlider" style="width: 100%; margin: 10px 0;" min="5" max="80" value="15" oninput="updateAudioThreshold(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 0.8em; opacity: 0.7; margin-top: -5px;">
                    <span>極靈敏 (5)</span>
                    <span>中等 (25)</span>
                    <span>高閾值 (80)</span>
                </div>
                
                <div class="row"><span>持續時間:</span><span id="audioDurationValue">2 秒</span></div>
                <input type="range" id="audioDurationSlider" style="width: 100%; margin: 10px 0;" min="1" max="10" value="2" oninput="updateAudioDuration(this.value)">
                
                <div class="row">
                    <span>自動觸發錄製:</span>
                    <input type="checkbox" id="audioAutoTrigger" checked onchange="updateAudioAutoTrigger(this.checked)">
                    <span id="audioAutoStatus">✅ 啟用</span>
                </div>
                
                <h3 style="margin-top: 20px;">📹 錄製設定</h3>
                <div class="row">
                    <span>同時錄音錄影:</span>
                    <input type="checkbox" id="recordBoth" checked onchange="updateRecordBoth(this.checked)">
                    <span id="recordBothStatus">✅ 啟用</span>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #ffa500;" id="recordingModeTitle">📹 錄影功能說明</h4>
                    <p style="font-size: 0.9em; line-height: 1.4; margin: 0;" id="recordingModeDesc">• 啟用後偵測到聲音時會同時錄製視頻和音頻<br>• 錄影解析度: 1280x720 @ 30fps<br>• 需要額外的攝影機權限<br>• 檔案大小會比純音頻大很多</p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="resetSettings()">🔄 重置設定</button>
                    <button class="btn" onclick="exportSettings()" style="background: #27ae60;">📤 匯出設定</button>
                </div>
            </div>
        </div>
        
        <div id="files" class="content hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">📁 錄製檔案</h2>
            <div class="status">
                <div class="row"><span>📊 檔案數:</span><span id="fileCount">0 個</span></div>
                <div class="row"><span>💾 空間:</span><span id="storageInfo">0 MB / 2 GB</span></div>
            </div>
            <div class="grid" id="filesGrid">
                <div class="card">
                    <span class="icon">📭</span>
                    <h4>暫無錄製檔案</h4>
                    <p>開始錄製後檔案將顯示在這裡</p>
                </div>
            </div>
        </div>
        
        <div id="models" class="content hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">🤖 AI模型管理</h2>
            <div class="status">
                <div class="row"><span>🔄 最後更新:</span><span id="lastUpdateTime">2025-01-07 14:30</span></div>
                <div class="row"><span>📡 連線狀態:</span><span id="connectionStatus" style="color: #27ae60;">✅ 已連線</span></div>
                <div class="row"><span>🎯 自動更新:</span><input type="checkbox" id="autoUpdate" checked onchange="updateAutoUpdate(this.checked)"> <span id="autoUpdateStatus">✅ 啟用</span></div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="checkForUpdates()" id="checkUpdatesBtn">🔍 檢查更新</button>
                <button class="btn" onclick="downloadAllModels()" style="background: #27ae60;">📥 下載全部</button>
            </div>
            
            <div class="grid" id="modelsGrid">
                <div class="card">
                    <span class="icon">🎵</span>
                    <h4>聲音識別模型</h4>
                    <p><strong>版本:</strong> <span id="audioModelVersion">v2.3.1</span></p>
                    <p><strong>狀態:</strong> <span id="audioModelStatus" style="color: #27ae60;">✅ 已載入</span></p>
                    <p><strong>大小:</strong> <span id="audioModelSize">15.2 MB</span></p>
                    <p><strong>準確率:</strong> <span id="audioModelAccuracy">94.7%</span></p>
                    <div style="margin: 10px 0;">
                        <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px;">
                            <div style="background: #27ae60; height: 100%; border-radius: 10px; width: 95%;"></div>
                        </div>
                    </div>
                    <button class="btn" onclick="updateModel('audio')" style="font-size: 0.8em; padding: 8px 16px;">🔄 更新模型</button>
                    <button class="btn" onclick="testModel('audio')" style="font-size: 0.8em; padding: 8px 16px; background: #3742fa;">🧪 測試</button>
                </div>
            </div>
        </div>
        
        <p style="text-align: center; margin-top: 30px; opacity: 0.7; font-size: 0.9em;">
            版本 v1.1.7 | 修復監聽循環停止問題 | 512MB RAM最佳化
        </p>
    </div>
    
    <script>
        let recording = false, time = 0, interval, mediaRecorder, recordedChunks = [], stream;
        let autoStopTimeout; // 自動停止錄製的計時器
        let recordingFiles = JSON.parse(localStorage.getItem('tcldcam_files') || '[]');
        
        // 精確的音頻偵測變量
        let audioDetectionActive = false;
        let visualDetectionActive = false;
        let audioContext, analyser, microphone, dataArray;
        let videoElement, canvas, canvasContext;
        let lastFrameData = null;
        let videoRecordingStream = null;
        
        let detectionSettings = {
            audioThreshold: 15, // 降低預設閾值使其更容易觸發
            audioDuration: 2,
            audioAutoTrigger: true,
            visualSensitivity: 50,
            detectionArea: 'full',
            motionDetection: true,
            autoRecording: true,
            recordBoth: true
        };
        
        function show(tab) {
            document.querySelectorAll('.content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tab === 'files') {
                updateFilesList();
            }
        }
        
        async function toggle() {
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('status');
            
            if (!audioDetectionActive && !visualDetectionActive) {
                // Start auto detection
                try {
                    await startAutoDetection();
                    btn.textContent = '⏹️ 停止偵測';
                    btn.classList.add('active');
                    status.textContent = '👁️🎵 自動偵測中';
                    console.log('✅ 自動偵測已啟動');
                } catch (error) {
                    console.log('⚠️ 權限被拒絕，使用模擬模式');
                    startSimulatedDetection();
                    btn.textContent = '⏹️ 停止偵測';
                    btn.classList.add('active');
                    status.textContent = '👁️🎵 模擬偵測中';
                }
            } else {
                // Stop auto detection
                if (recording) {
                    // 如果正在錄製，提供手動停止選項
                    if (confirm('目前正在錄製中，確定要停止偵測和錄製嗎？')) {
                        stopTriggeredRecording(); // 先停止錄製
                        stopAutoDetection(); // 再停止偵測
                        btn.textContent = detectionSettings.recordBoth ? '🎬 開始錄影偵測' : '🎤 開始錄音偵測';
                        btn.classList.remove('active');
                        status.textContent = '手動停止';
                        console.log('✋ 用戶手動停止偵測和錄製');
                    }
                } else {
                    stopAutoDetection();
                    btn.textContent = detectionSettings.recordBoth ? '🎬 開始錄影偵測' : '🎤 開始錄音偵測';
                    btn.classList.remove('active');
                    status.textContent = '待機中';
                    console.log('⏹️ 自動偵測已停止');
                }
            }
        }
        
        async function startAutoDetection() {
            try {
                console.log('🎵 請求音頻權限...');
                
                // macOS 特殊音頻配置
                const isMacOS = navigator.platform.indexOf('Mac') > -1;
                const audioConstraints = {
                    audio: {
                        echoCancellation: false, // macOS Safari 可能與這個有問題
                        noiseSuppression: false, // 關閉降噪以獲得更原始數據
                        autoGainControl: false,  // 關閉自動增益控制
                        sampleRate: { ideal: 44100 }, // macOS 標準采樣率
                        channelCount: { ideal: 1 },   // 單聲道
                    }
                };
                
                console.log(`🖥️ 當前平台: ${navigator.platform}`);
                console.log(`📱 用戶代理: ${navigator.userAgent.substring(0, 100)}...`);
                
                const audioStream = await navigator.mediaDevices.getUserMedia(
                    isMacOS ? audioConstraints : { audio: true }
                );
                console.log('✅ 音頻權限獲取成功');
                console.log(`🎤 音頻軌道數量: ${audioStream.getAudioTracks().length}`);
                console.log(`🎤 音頻軌道設定: ${JSON.stringify(audioStream.getAudioTracks()[0].getSettings())}`);
                
                // Setup audio detection first
                if (detectionSettings.audioAutoTrigger) {
                    setupAudioDetection(audioStream);
                    audioDetectionActive = true;
                    console.log('✅ 音頻偵測已啟動');
                }
                
                // Try video separately (might be denied)
                if (detectionSettings.motionDetection) {
                    try {
                        console.log('📹 請求視頻權限...');
                        const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        console.log('✅ 視頻權限獲取成功');
                        setupVisualDetection(videoStream);
                        visualDetectionActive = true;
                        console.log('✅ 視覺偵測已啟動');
                    } catch (videoError) {
                        console.log('⚠️ 視頻權限被拒絕，僅使用音頻偵測');
                    }
                }
                
                stream = audioStream; // Keep reference for cleanup
                
                console.log(`🎵 音頻閾值: ${detectionSettings.audioThreshold} dB`);
                console.log(`👁️ 視覺靈敏度: ${detectionSettings.visualSensitivity}%`);
                console.log(`⏱️ 錄製時長: ${detectionSettings.audioDuration} 秒`);
                
                // 提示用戶測試
                alert('✅ 高精度偵測系統已啟動！\n\n🎵 請對著麥克風說話或發出聲音\n🔍 檢查下方"實時"欄位查看 RMS 數值\n🎯 可在設定中調整閾值 (10-60dB)\n🔧 建議先試 20-35dB 範圍');
                
            } catch (error) {
                console.error('自動偵測啟動失敗:', error);
                throw error;
            }
        }
        
        function setupAudioDetection(audioStream) {
            try {
                // macOS Safari 特殊處理
                const isMacOS = navigator.platform.indexOf('Mac') > -1;
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                
                console.log(`🖥️ 平台檢測: macOS=${isMacOS}, Safari=${isSafari}`);
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 44100, // macOS 偏好的采樣率
                    latencyHint: 'interactive' // 減少延遲
                });
                
                console.log(`🎵 音頻上下文狀態: ${audioContext.state}`);
                console.log(`🎵 采樣率: ${audioContext.sampleRate} Hz`);
                
                // macOS Safari 需要用戶手勢激活音頻上下文
                if (audioContext.state === 'suspended') {
                    console.log('🔊 音頻上下文被暫停，需要用戶手勢激活...');
                    // 立即嘗試恢復
                    audioContext.resume().then(() => {
                        console.log('✅ 音頻上下文恢復成功');
                    }).catch(error => {
                        console.error('❌ 音頻上下文恢復失敗:', error);
                        alert('⚠️ macOS Safari 需要您點擊頁面任意處來激活音頻偵測功能');
                    });
                }
                
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(audioStream);
                
                // 重新設定分析器參數以獲得更精確的音量測量
                analyser.fftSize = 2048; // 更高精度
                analyser.smoothingTimeConstant = 0.1; // 降低平滑化以獲得更即時的音量
                analyser.minDecibels = -90;
                analyser.maxDecibels = -10;
                
                const bufferLength = analyser.fftSize; // 使用時域數據長度
                dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                console.log('🎵 音頻偵測初始化成功');
                console.log(`   - FFT 大小: ${analyser.fftSize}`);
                console.log(`   - 緩衝區長度: ${bufferLength}`);
                console.log(`   - 樣本率: ${audioContext.sampleRate} Hz`);
                console.log(`   - 音頻範圍: ${analyser.minDecibels} 到 ${analyser.maxDecibels} dB`);
                console.log(`   - 平滑化: ${analyser.smoothingTimeConstant}`);
                console.log(`   - 音頻上下文狀態: ${audioContext.state}`);
                
                // Start audio monitoring - 強制啟動
                console.log('🚀 強制啟動音頻監聽循環...');
                monitorAudio();
                
                // 備用監聽器 - 確保一定有監聽在運行
                setInterval(() => {
                    if (audioDetectionActive && analyser && audioContext && audioContext.state === 'running') {
                        // 檢查監聽是否還在運行
                        const currentTime = Date.now();
                        if (!window.lastAudioCheck || currentTime - window.lastAudioCheck > 3000) {
                            console.log('🔄 備用監聽器檢測到監聽可能停止，重新啟動...');
                            monitorAudio();
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.error('音頻偵測初始化失敗:', error);
                throw error;
            }
        }
        
        function monitorAudio() {
            if (!audioDetectionActive || !analyser) {
                if (!audioDetectionActive) console.log('⚠️ audioDetectionActive = false, 停止監聽');
                if (!analyser) console.log('⚠️ analyser 未初始化, 停止監聽');
                return;
            }
            
            // macOS Safari 音頻上下文狀態檢查
            if (audioContext && audioContext.state !== 'running') {
                console.log(`⚠️ 音頻上下文狀態: ${audioContext.state}, 嘗試恢復並繼續監聽...`);
                audioContext.resume();
                // 繼續監聽，不要停止
                requestAnimationFrame(monitorAudio);
                return;
            }
            
            try {
                // 心跳檢測 - 記錄監聽器還在運行
                window.lastAudioCheck = Date.now();
                
                // 使用時域數據獲得真實的音量測量
                analyser.getByteTimeDomainData(dataArray);
                
                // 計算真正的 RMS 音量
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    const amplitude = (dataArray[i] - 128) / 128; // 正規化到 -1 到 1
                    sum += amplitude * amplitude;
                }
                const rms = Math.sqrt(sum / dataArray.length);
                
                // 新的實用音頻測量系統 - 使用百分比方式
                const volumePercentage = Math.floor(rms * 100); // 0-100% 音量
                
                // 傳統 dB 轉換作為參考
                const traditionalDb = rms > 0.001 ? Math.max(0, Math.min(100, 20 * Math.log10(rms) + 80)) : 0;
                
                // 使用範圍 0-100 的線性音量值，更直觀
                const linearVolume = Math.floor(Math.sqrt(rms) * 100); // 平方根轉換，更合理
                const displayVolumeDb = Math.max(volumePercentage, linearVolume); // 取較高值
                
                // Update volume display with more intuitive values
                document.getElementById('volume').textContent = `${displayVolumeDb} dB`;
                
                // 使用新的音量系統進行閾值比較
                const thresholdMet = displayVolumeDb >= detectionSettings.audioThreshold;
                
                // 實時除錯資訊 - 更詳細的狀態
                const debugText = `${thresholdMet ? '🔥觸發' : '⭕未觸發'} ${displayVolumeDb}/${detectionSettings.audioThreshold}dB [RMS:${(rms*1000).toFixed(1)}]`;
                document.getElementById('debug').textContent = debugText;
                
                // 加強的除錯記錄
                if (displayVolumeDb > 3) { // 降低門檻
                    const status = thresholdMet ? '🔥觸發' : '⭕無觸發';
                    const autoStatus = detectionSettings.audioAutoTrigger ? '✅ON' : '❌OFF';
                    console.log(`🎵 ${status}: ${displayVolumeDb}dB>=${detectionSettings.audioThreshold}dB, RMS=${(rms*1000).toFixed(2)}, 自動錄製:${autoStatus}, 錄製中:${recording}`);
                }
                
                // 加強觸發檢查
                if (thresholdMet) {
                    console.log(`🚨 音頻閾值達到! 立即調用 triggerAudioDetection(${displayVolumeDb})`);
                    triggerAudioDetection(displayVolumeDb);
                } else if (displayVolumeDb > detectionSettings.audioThreshold * 0.8) {
                    // 接近閾值時的提示
                    console.log(`🟡 接近閾值: ${displayVolumeDb}dB (${(displayVolumeDb/detectionSettings.audioThreshold*100).toFixed(0)}%)`);
                }
                
            } catch (error) {
                console.error('❌ 音頻分析錯誤:', error);
                console.error('錯誤詳情:', error.message);
                // 即使出錯也要繼續監聽
            }
            
            // 強制繼續監聽 - 無論如何都要繼續
            if (audioDetectionActive) {
                requestAnimationFrame(monitorAudio);
            } else {
                console.log('🛑 audioDetectionActive = false, 停止監聽循環');
            }
        }
        
        let lastTriggerTime = 0;
        
        function triggerAudioDetection(volume) {
            const now = Date.now();
            // 降低防抖間隔到 1 秒，避免錯過觸發
            if (now - lastTriggerTime < 1000) {
                console.log(`⏱️ 觸發防抖中，距離上次觸發 ${now - lastTriggerTime}ms`);
                return;
            }
            lastTriggerTime = now;
            
            const status = document.getElementById('status');
            status.textContent = `🔥 音頻觸發! (${volume} dB)`;
            console.log(`🔥 音頻偵測觸發: ${volume} dB (閾值: ${detectionSettings.audioThreshold}dB)`)
            console.log(`📊 當前狀態: audioAutoTrigger=${detectionSettings.audioAutoTrigger}, recording=${recording}, audioDetectionActive=${audioDetectionActive}`);
            
            // 視覺特效：狀態欄閃爍
            status.style.background = 'linear-gradient(45deg, #ff6b6b, #ff4757)';
            status.style.transform = 'scale(1.05)';
            status.style.transition = 'all 0.3s ease';
            
            // 音效提示（如果支持）
            if (typeof Audio !== 'undefined') {
                try {
                    // 用 Web Audio API 生成簡單提示音
                    if (audioContext && audioContext.state === 'running') {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = 800; // 800Hz 音頻
                        gainNode.gain.value = 0.1; // 低音量
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.1); // 0.1秒短音
                    }
                } catch (e) {
                    console.log('無法播放提示音');
                }
            }
            
            // 立即觸發錄音，無延遲
            if (detectionSettings.audioAutoTrigger) {
                if (recording) {
                    console.log(`⚠️ 已在錄製中，重設計時器 (觸發值: ${volume}dB)`);
                    // 重設錄製計時器，延長錄製時間
                    if (autoStopTimeout) {
                        clearTimeout(autoStopTimeout);
                    }
                    autoStopTimeout = setTimeout(() => {
                        if (recording) {
                            console.log('⏰ 延長錄製時間結束，自動停止');
                            stopTriggeredRecording();
                        }
                    }, detectionSettings.audioDuration * 1000);
                } else {
                    console.log(`🚀 立即觸發自動錄製 (${volume}dB >= ${detectionSettings.audioThreshold}dB)`);
                    // 立即觸發，無延遲
                    try {
                        startTriggeredRecording('audio', volume);
                    } catch (error) {
                        console.error('❌ 自動錄製觸發失敗:', error);
                    }
                }
            } else {
                console.log('⚠️ 自動觸發功能已關閉，僅提示偵測到聲音');
            }
            
            // Reset status after 3 seconds
            setTimeout(() => {
                if (audioDetectionActive) {
                    status.textContent = '👁️🎵 自動偵測中';
                    status.style.background = '';
                    status.style.transform = '';
                }
            }, 3000);
        }
        
        // Settings page functions
        function updateAudioThreshold(value) {
            document.getElementById('audioThresholdValue').textContent = `${value} dB`;
            detectionSettings.audioThreshold = parseInt(value);
            
            // 計算對應的 RMS 閾值
            const thresholdRms = Math.pow(10, (value - 60) / 20);
            console.log(`🎵 音頻閾值設定為: ${value} dB (RMS 閾值: ${(thresholdRms * 100).toFixed(2)}%)`);
            
            // 提供設定建議
            if (value < 20) {
                console.log('⚠️ 閾值太低，可能會頻繁觸發');
            } else if (value > 50) {
                console.log('⚠️ 閾值太高，可能難以觸發');
            }
        }
        
        function updateAudioDuration(value) {
            document.getElementById('audioDurationValue').textContent = `${value} 秒`;
            detectionSettings.audioDuration = parseInt(value);
            
            if (detectionSettings.recordBoth) {
                console.log(`⏱️ 錄影持續時間設定為: ${value} 秒`);
            } else {
                console.log(`⏱️ 錄音持續時間設定為: ${value} 秒 (僅錄音模式，可手動停止)`);
            }
        }
        
        function updateAudioAutoTrigger(checked) {
            document.getElementById('audioAutoStatus').textContent = checked ? '✅ 啟用' : '❌ 關閉';
            detectionSettings.audioAutoTrigger = checked;
            console.log(`🔄 音頻自動觸發錄製: ${checked ? '啟用' : '關閉'}`);
            
            if (!checked) {
                console.log('⚠️ 自動觸發錄製已關閉，偵測到聲音時只會顯示提示，不會自動開始錄製');
            } else {
                console.log('✅ 自動觸發錄製已啟用，偵測到聲音時會自動開始錄製');
            }
        }
        
        function updateRecordBoth(checked) {
            document.getElementById('recordBothStatus').textContent = checked ? '✅ 啟用' : '❌ 關閉';
            detectionSettings.recordBoth = checked;
            console.log(`🎥🎵 同時錄音錄影: ${checked ? '啟用' : '關閉'}`);
            
            // 更新按鈕文字提示
            const recordBtn = document.getElementById('recordBtn');
            if (recordBtn && !audioDetectionActive) {
                recordBtn.innerHTML = checked ? '🎬 開始錄影偵測' : '🎤 開始錄音偵測';
            }
            
            // 動態更新功能說明
            const titleElement = document.getElementById('recordingModeTitle');
            const descElement = document.getElementById('recordingModeDesc');
            
            if (checked) {
                titleElement.textContent = '📹 錄影功能說明';
                descElement.innerHTML = '• 啟用後偵測到聲音時會同時錄製視頻和音頻<br>• 錄影解析度: 1280x720 @ 30fps<br>• 需要額外的攝影機權限<br>• 檔案大小會比純音頻大很多<br>• 自動停止時間由"持續時間"設定決定';
            } else {
                titleElement.textContent = '🎤 純錄音功能說明';
                descElement.innerHTML = '• 關閉錄影後，僅錄製音頻<br>• 文件較小，節省儲存空間<br>• 不需攝影機權限<br>• <strong>錄音將持續進行直到手動停止或達到最長時間</strong><br>• 可透過"停止偵測"按鈕手動中斷錄製';
            }
        }
        
        function resetSettings() {
            if (confirm('確定要重置所有設定嗎？')) {
                // Reset all sliders and checkboxes
                document.getElementById('audioThresholdSlider').value = 30;
                document.getElementById('audioDurationSlider').value = 2;
                document.getElementById('audioAutoTrigger').checked = true;
                document.getElementById('recordBoth').checked = true;
                
                // Update displays
                updateAudioThreshold(30);
                updateAudioDuration(2);
                updateAudioAutoTrigger(true);
                updateRecordBoth(true);
                
                console.log('🔄 設定已重置為預設值');
                alert('✅ 設定已重置為預設值');
            }
        }
        
        function exportSettings() {
            const settings = {
                audioThreshold: document.getElementById('audioThresholdSlider').value,
                audioDuration: document.getElementById('audioDurationSlider').value,
                audioAutoTrigger: document.getElementById('audioAutoTrigger').checked,
                recordBoth: document.getElementById('recordBoth').checked,
                exportTime: new Date().toLocaleString('zh-TW')
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TCLDCAM_設定_${new Date().toISOString().substring(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('📤 設定已匯出');
            alert('✅ 設定檔案已下載');
        }
        
        // Models page functions
        function updateAutoUpdate(checked) {
            document.getElementById('autoUpdateStatus').textContent = checked ? '✅ 啟用' : '❌ 關閉';
            console.log(`🤖 自動更新: ${checked ? '啟用' : '關閉'}`);
        }
        
        function checkForUpdates() {
            const btn = document.getElementById('checkUpdatesBtn');
            btn.textContent = '🔄 檢查中...';
            btn.disabled = true;
            
            // 模擬檢查更新
            setTimeout(() => {
                const hasUpdates = Math.random() > 0.5;
                if (hasUpdates) {
                    alert('🎉 發現新版本！\n\n聲音識別模型: v2.3.1 → v2.3.2\n\n點擊確定開始下載更新。');
                    document.getElementById('audioModelVersion').textContent = 'v2.3.2';
                } else {
                    alert('✅ 所有模型已是最新版本');
                }
                document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-TW').substring(0,16);
                btn.textContent = '🔍 檢查更新';
                btn.disabled = false;
            }, 2000);
        }
        
        function downloadAllModels() {
            if (confirm('確定要下載所有模型嗎？這將需要約 84MB 的空間。')) {
                alert('📥 開始下載所有模型...\n\n預計需要 2-3 分鐘完成\n請保持網路連線穩定');
                console.log('📥 開始下載所有AI模型');
            }
        }
        
        function updateModel(type) {
            const models = {
                'audio': '聲音識別模型'
            };
            
            if (confirm(`確定要更新${models[type]}嗎？`)) {
                alert(`🔄 正在更新${models[type]}...\n\n下載進度將在控制台顯示`);
                console.log(`🔄 開始更新 ${models[type]}`);
                
                // Simulate update progress
                setTimeout(() => {
                    console.log(`✅ ${models[type]} 更新完成`);
                    alert(`✅ ${models[type]} 更新成功！`);
                }, 3000);
            }
        }
        
        function testRecording() {
            if (recording) {
                console.log('⚠️ 已在錄製中，無法測試');
                alert('目前已在錄製中，請等待結束後再測試');
                return;
            }
            
            console.log('🧪 開始測試錄製功能...');
            const status = document.getElementById('status');
            status.textContent = '🧪 測試錄製中...';
            
            // 直接調用錄製函數測試
            startTriggeredRecording('test', 50)
                .then(() => {
                    console.log('✅ 測試錄製啟動成功');
                })
                .catch(error => {
                    console.error('❌ 測試錄製失敗:', error);
                    alert(`測試錄製失敗: ${error.message}\n\n請檢查瀏覽器權限設定。`);
                });
        }
        
        function forceAudioTest() {
            console.log('⚡ 強制音頻測試開始...');
            
            // 強制檢查所有關鍵變量
            console.log(`🔍 全面檢查:`);
            console.log(`   audioDetectionActive: ${audioDetectionActive}`);
            console.log(`   analyser: ${analyser ? '已初始化' : '未初始化'}`);
            console.log(`   audioContext: ${audioContext ? audioContext.state : '未初始化'}`);
            console.log(`   stream: ${stream ? '已連接' : '未連接'}`);
            console.log(`   audioAutoTrigger: ${detectionSettings.audioAutoTrigger}`);
            console.log(`   audioThreshold: ${detectionSettings.audioThreshold}dB`);
            
            if (audioDetectionActive && analyser) {
                console.log('🔥 強制執行一次音頻分析...');
                
                // 強制執行一次監聽循環
                try {
                    analyser.getByteTimeDomainData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        const amplitude = (dataArray[i] - 128) / 128;
                        sum += amplitude * amplitude;
                    }
                    const rms = Math.sqrt(sum / dataArray.length);
                    const volumePercentage = Math.floor(rms * 100);
                    const linearVolume = Math.floor(Math.sqrt(rms) * 100);
                    const displayVolumeDb = Math.max(volumePercentage, linearVolume);
                    
                    console.log(`⚡ 強制測試結果: ${displayVolumeDb}dB (RMS: ${(rms*1000).toFixed(2)})`);
                    
                    // 強制更新UI
                    document.getElementById('volume').textContent = `${displayVolumeDb} dB`;
                    document.getElementById('debug').textContent = `⚡強制測試: ${displayVolumeDb}/${detectionSettings.audioThreshold}dB`;
                    
                    // 強制觸發測試（如果超過閾值）
                    if (displayVolumeDb >= detectionSettings.audioThreshold) {
                        console.log('🚨 強制測試觸發條件滿足，立即觸發！');
                        triggerAudioDetection(displayVolumeDb);
                    }
                    
                    alert(`⚡ 強制測試完成\n\n音量: ${displayVolumeDb}dB\n閾值: ${detectionSettings.audioThreshold}dB\n${displayVolumeDb >= detectionSettings.audioThreshold ? '✅ 應該觸發' : '❌ 未達閾值'}`);
                    
                } catch (error) {
                    console.error('❌ 強制測試失敗:', error);
                    alert(`❌ 強制測試失敗: ${error.message}`);
                }
            } else {
                alert('❌ 無法進行強制測試\n請先啟動音頻偵測功能');
            }
            
            // 重新啟動監聽循環
            if (audioDetectionActive && analyser) {
                console.log('🔄 重新啟動監聽循環...');
                monitorAudio();
            }
        }
        
        function diagnoseMacOS() {
            console.log('🍎 開始 macOS 音頻診斷...');
            
            const isMacOS = navigator.platform.indexOf('Mac') > -1;
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isChrome = navigator.userAgent.indexOf('Chrome') > -1;
            
            let diagnosis = '🍎 macOS 音頻診斷報告\n\n';
            diagnosis += `🖥️ 平台: ${navigator.platform}\n`;
            diagnosis += `🌐 瀏覽器: ${isSafari ? 'Safari' : isChrome ? 'Chrome' : 'Other'}\n`;
            diagnosis += `📱 用戶代理: ${navigator.userAgent.substring(0, 80)}...\n\n`;
            
            // 音頻上下文檢查
            if (audioContext) {
                diagnosis += `🎵 音頻上下文狀態: ${audioContext.state}\n`;
                diagnosis += `🎵 采樣率: ${audioContext.sampleRate} Hz\n`;
                diagnosis += `🎵 偵測活動: ${audioDetectionActive ? '✅ 是' : '❌ 否'}\n`;
            } else {
                diagnosis += `❌ 音頻上下文未初始化\n`;
            }
            
            // 權限檢查
            if (navigator.mediaDevices) {
                navigator.permissions.query({ name: 'microphone' }).then(result => {
                    diagnosis += `🎤 麥克風權限: ${result.state}\n`;
                    console.log(diagnosis);
                    alert(diagnosis + '\n📋 詳細信息已輸出到 Console');
                }).catch(() => {
                    console.log(diagnosis);
                    alert(diagnosis + '\n📋 詳細信息已輸出到 Console');
                });
            } else {
                diagnosis += `❌ MediaDevices API 不可用\n`;
                console.log(diagnosis);
                alert(diagnosis);
            }
            
            // 測試音頻上下文激活
            if (audioContext && audioContext.state === 'suspended') {
                diagnosis += `\n💡 建議: 點擊頁面任意處激活音頻上下文`;
                audioContext.resume().then(() => {
                    console.log('✅ 診斷過程中成功激活音頻上下文');
                });
            }
            
            // 檢查是否有活動的音頻軌道
            if (stream && stream.getAudioTracks().length > 0) {
                const track = stream.getAudioTracks()[0];
                diagnosis += `🎤 音頻軌道狀態: ${track.readyState}\n`;
                diagnosis += `🎤 音頻軌道設定: ${JSON.stringify(track.getSettings())}\n`;
            }
        }
        
        function testTrigger() {
            console.log('🔥 手動測試音頻觸發邏輯...');
            console.log(`🎯 當前設定: audioAutoTrigger=${detectionSettings.audioAutoTrigger}, audioThreshold=${detectionSettings.audioThreshold}dB`);
            console.log(`📊 當前狀態: audioDetectionActive=${audioDetectionActive}, recording=${recording}`);
            
            if (!audioDetectionActive) {
                alert('請先點擊「開始錄影偵測」啟動偵測功能，然後再測試觸發。');
                return;
            }
            
            // 模擬觸發音頻偵測
            const testVolume = detectionSettings.audioThreshold + 10; // 超過閾值10dB
            console.log(`🧪 模擬音頻觸發: ${testVolume}dB (閾值: ${detectionSettings.audioThreshold}dB)`);
            console.log(`🔧 檢查清單:`);
            console.log(`   - 偵測已啟動: ${audioDetectionActive ? '✅' : '❌'}`);
            console.log(`   - 自動觸發: ${detectionSettings.audioAutoTrigger ? '✅' : '❌'}`);
            console.log(`   - 目前錄製中: ${recording ? '✅' : '❌'}`);
            
            alert(`🧪 測試觸發開始！\n\n設定檢查:\n✅ 偵測活動: ${audioDetectionActive}\n✅ 自動觸發: ${detectionSettings.audioAutoTrigger}\n✅ 測試音量: ${testVolume}dB\n✅ 閾值設定: ${detectionSettings.audioThreshold}dB\n\n請觀察 Console 和狀態顯示的變化。`);
            
            // 立即觸發測試
            triggerAudioDetection(testVolume);
            
            // 3秒後再次顯示結果
            setTimeout(() => {
                const success = recording || (Date.now() - lastTriggerTime < 5000);
                console.log(`🧪 測試結果: ${success ? '✅ 觸發成功' : '❌ 觸發失敗'}`);
                alert(`🧪 測試結果: ${success ? '✅ 觸發成功，已開始錄製' : '❌ 觸發失敗，請檢查設定'}`);
            }, 3000);
        }
        
        function testModel(type) {
            const models = {
                'audio': '聲音識別模型'
            };
            
            alert(`🧪 開始測試${models[type]}...\n\n測試結果將在 5 秒後顯示`);
            console.log(`🧪 測試 ${models[type]}`);
            
            setTimeout(() => {
                const accuracy = (Math.random() * 10 + 90).toFixed(1);
                const responseTime = (Math.random() * 0.5 + 0.1).toFixed(2);
                alert(`📊 ${models[type]} 測試結果:\n\n✅ 準確率: ${accuracy}%\n⚡ 響應時間: ${responseTime} 秒\n🎯 狀態: 正常運行`);
                
                if (type === 'audio') {
                    document.getElementById('audioModelAccuracy').textContent = `${accuracy}%`;
                }
            }, 5000);
        }
        
        async function startTriggeredRecording(triggerType, triggerValue) {
            if (recording) {
                console.log('⚠️ startTriggeredRecording: 已經在錄製中，跳過');
                return;
            }
            
            console.log(`🚀 startTriggeredRecording 開始: ${triggerType}, 值: ${triggerValue}`);
            
            try {
                let recordingStream;
                
                // 根據設定決定錄製類型
                if (detectionSettings.recordBoth) {
                    // 錄影 + 錄音
                    console.log('🎬 請求錄影權限...');
                    try {
                        recordingStream = await navigator.mediaDevices.getUserMedia({ 
                            audio: true, 
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        });
                        console.log('✅ 錄影權限獲取成功');
                    } catch (videoError) {
                        console.log('⚠️ 錄影權限失敗，降級為僅錄音');
                        recordingStream = stream || await navigator.mediaDevices.getUserMedia({ audio: true });
                        // 臨時關閉錄影模式
                        detectionSettings.recordBoth = false;
                    }
                } else {
                    // 僅錄音 - 持續錄製直到手動停止或達到最大時長
                    console.log('🎤 僅錄音模式 - 持續錄製');
                    recordingStream = stream || await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                // 設定錄製格式
                const options = {
                    mimeType: detectionSettings.recordBoth ? 
                        (MediaRecorder.isTypeSupported('video/webm; codecs=vp9,opus') ? 'video/webm; codecs=vp9,opus' : 'video/webm') :
                        (MediaRecorder.isTypeSupported('audio/webm; codecs=opus') ? 'audio/webm; codecs=opus' : 'audio/webm')
                };
                
                mediaRecorder = new MediaRecorder(recordingStream, options);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    saveTriggeredRecording(triggerType, triggerValue);
                    // 停止錄影串流
                    if (detectionSettings.recordBoth && recordingStream !== stream) {
                        recordingStream.getTracks().forEach(track => track.stop());
                    }
                };
                
                mediaRecorder.start();
                recording = true;
                time = 0;
                interval = setInterval(updateDisplay, 1000);
                
                // 更新狀態顯示
                const status = document.getElementById('status');
                status.textContent = detectionSettings.recordBoth ? 
                    `🎬 自動錄影中 (${triggerType === 'audio' ? '音頻' : '視覺'}觸發)` :
                    `🎤 自動錄音中 (${triggerType === 'audio' ? '音頻' : '視覺'}觸發)`;
                
                console.log(`✅ 自動錄製開始 (觸發: ${triggerType}, 模式: ${detectionSettings.recordBoth ? '錄影+錄音' : '僅錄音'})`);
                
                // 如果是錄影，顯示預覽；如果僅錄音，顯示錄音指示
                if (detectionSettings.recordBoth) {
                    showVideoPreview(recordingStream);
                } else {
                    showAudioRecordingIndicator();
                }
                
                // 設置自動停止錄製計時器
                autoStopTimeout = setTimeout(() => {
                    if (recording) {
                        console.log('⏰ 達到最長錄製時間，自動停止');
                        stopTriggeredRecording();
                    }
                }, detectionSettings.audioDuration * 1000);
                
            } catch (error) {
                console.error('❌ startTriggeredRecording 失敗:', error);
                console.error('錯誤類型:', error.name);
                console.error('錯誤訊息:', error.message);
                
                // 顯示用戶友好的錯誤訊息
                const status = document.getElementById('status');
                status.textContent = `❌ 錄製失敗: ${error.name}`;
                
                // 降級到僅錄音
                if (detectionSettings.recordBoth && (error.name === 'NotAllowedError' || error.name === 'NotFoundError')) {
                    console.log('⚠️ 攝影機權限被拒絕或設備不可用，降級為僅錄音模式');
                    detectionSettings.recordBoth = false;
                    document.getElementById('recordBoth').checked = false;
                    updateRecordBoth(false);
                    
                    // 重試純音頻錄製
                    setTimeout(() => {
                        console.log('🔄 重試純音頻錄製...');
                        startTriggeredRecording(triggerType, triggerValue);
                    }, 500);
                } else {
                    // 其他錯誤，顯示3秒後清除
                    setTimeout(() => {
                        if (audioDetectionActive) {
                            status.textContent = '👁️🎵 自動偵測中';
                        }
                    }, 3000);
                }
            }
        }
        
        function stopTriggeredRecording() {
            if (!recording) return;
            
            recording = false;
            clearInterval(interval);
            
            // 清除自動停止計時器
            if (autoStopTimeout) {
                clearTimeout(autoStopTimeout);
                autoStopTimeout = null;
            }
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // 重置狀態顯示
            const status = document.getElementById('status');
            if (audioDetectionActive) {
                status.textContent = '👁️🎵 自動偵測中';
                status.style.background = '';
                status.style.transform = '';
            }
            
            console.log('⏹️ 自動錄製結束');
        }
        
        function showAudioRecordingIndicator() {
            // 創建音頻錄製指示器
            let audioIndicator = document.getElementById('audioIndicator');
            if (!audioIndicator) {
                audioIndicator = document.createElement('div');
                audioIndicator.id = 'audioIndicator';
                audioIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    width: 200px;
                    height: 80px;
                    background: rgba(255, 75, 87, 0.9);
                    border-radius: 10px;
                    border: 2px solid #ff6b6b;
                    z-index: 1000;
                    padding: 15px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                    color: white;
                    font-weight: bold;
                    animation: recordPulse 1.5s infinite;
                `;
                
                const icon = document.createElement('div');
                icon.textContent = '🎤';
                icon.style.cssText = 'font-size: 24px; margin-bottom: 5px;';
                
                const text = document.createElement('div');
                text.textContent = '錄音中...';
                text.style.cssText = 'font-size: 14px;';
                
                audioIndicator.appendChild(icon);
                audioIndicator.appendChild(text);
                document.body.appendChild(audioIndicator);
                
                // 添加脈衝動畫
                if (!document.getElementById('recordPulseStyle')) {
                    const style = document.createElement('style');
                    style.id = 'recordPulseStyle';
                    style.textContent = '@keyframes recordPulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }';
                    document.head.appendChild(style);
                }
            }
        }
        
        function hideAudioRecordingIndicator() {
            const audioIndicator = document.getElementById('audioIndicator');
            if (audioIndicator) {
                audioIndicator.remove();
            }
        }
        
        function showVideoPreview(stream) {
            // 創建小型預覽窗口
            let previewDiv = document.getElementById('videoPreview');
            if (!previewDiv) {
                previewDiv = document.createElement('div');
                previewDiv.id = 'videoPreview';
                previewDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    width: 200px;
                    height: 150px;
                    background: rgba(0,0,0,0.8);
                    border-radius: 10px;
                    border: 2px solid #ff6b6b;
                    z-index: 1000;
                    padding: 5px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                `;
                document.body.appendChild(previewDiv);
                
                const video = document.createElement('video');
                video.id = 'previewVideo';
                video.style.cssText = 'width: 100%; height: 120px; border-radius: 5px;';
                video.autoplay = true;
                video.muted = true;
                
                const label = document.createElement('div');
                label.textContent = '🔴 錄影中';
                label.style.cssText = 'color: #ff6b6b; font-size: 12px; margin-top: 5px; text-align: center; animation: blink 1s infinite;';
                
                previewDiv.appendChild(video);
                previewDiv.appendChild(label);
                
                // 添加閃爍動畫
                const style = document.createElement('style');
                style.textContent = '@keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }';
                document.head.appendChild(style);
            }
            
            const video = document.getElementById('previewVideo');
            if (video && stream) {
                video.srcObject = stream;
            }
        }
        
        function hideVideoPreview() {
            const previewDiv = document.getElementById('videoPreview');
            if (previewDiv) {
                previewDiv.remove();
            }
        }
        
        function saveTriggeredRecording(triggerType, triggerValue) {
            const isVideo = detectionSettings.recordBoth;
            const mimeType = isVideo ? 'video/webm' : 'audio/webm';
            const blob = new Blob(recordedChunks, { type: mimeType });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const triggerText = triggerType === 'audio' ? `音頻${triggerValue}dB` : `視覺${triggerValue.toFixed(1)}%`;
            const filePrefix = isVideo ? '錄影' : '錄音';
            const fileName = `${filePrefix}_${triggerText}_${timestamp.substring(11,19)}.webm`;
            
            const reader = new FileReader();
            reader.onloadend = () => {
                const fileData = {
                    id: Date.now(),
                    name: fileName,
                    type: isVideo ? 'video' : 'audio',
                    duration: time,
                    size: blob.size,
                    data: reader.result,
                    timestamp: new Date().toLocaleString('zh-TW'),
                    triggerType: `${triggerType === 'audio' ? '🎵' : '👁️'} ${triggerText}觸發`,
                    autoRecorded: true,
                    isVideo: isVideo
                };
                
                recordingFiles.unshift(fileData);
                if (recordingFiles.length > 10) {
                    recordingFiles = recordingFiles.slice(0, 10);
                }
                
                localStorage.setItem('tcldcam_files', JSON.stringify(recordingFiles));
                console.log(`✅ 自動${isVideo ? '錄影' : '錄音'}保存: ${fileName} (${formatFileSize(blob.size)})`);
                
                // Hide video preview or audio indicator
                if (isVideo) {
                    hideVideoPreview();
                } else {
                    hideAudioRecordingIndicator();
                }
                
                // Show notification
                showNotification(`${isVideo ? '🎬' : '🎤'} 自動${isVideo ? '錄影' : '錄音'}完成\n${fileName}\n時長: ${formatDuration(time)}\n大小: ${formatFileSize(blob.size)}`);
            };
            reader.readAsDataURL(blob);
        }
        
        function startSimulatedDetection() {
            audioDetectionActive = true;
            visualDetectionActive = true;
            
            // 提高模擬觸發率以便測試
            const simulateDetection = () => {
                if (!audioDetectionActive) return;
                
                // 提高音頻偵測模擬率（20% 機率每 3 秒）
                if (Math.random() < 0.2) {
                    const fakeVolume = Math.random() * 20 + detectionSettings.audioThreshold + 5; // 超過閾值
                    console.log(`🤖 模擬音頻觸發: ${fakeVolume.toFixed(1)} dB (閾值: ${detectionSettings.audioThreshold} dB)`);
                    triggerAudioDetection(Math.floor(fakeVolume));
                }
                
                // 縮短模擬間隔到 3 秒
                setTimeout(simulateDetection, 3000);
            };
            
            simulateDetection();
        }
        
        function stopAutoDetection() {
            audioDetectionActive = false;
            visualDetectionActive = false;
            
            // Clean up audio context
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // Clean up video element
            if (videoElement) {
                videoElement.srcObject?.getTracks().forEach(track => track.stop());
                videoElement.remove();
                videoElement = null;
            }
            
            // Clean up stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Stop any ongoing recording
            if (recording) {
                stopTriggeredRecording();
            }
            
            lastFrameData = null;
        }
        
        function showNotification(message) {
            // Simple alert for now (could be enhanced with custom notification UI)
            if (Notification && Notification.permission === 'granted') {
                new Notification('TCLDCAM 自動偵測', {
                    body: message,
                    icon: '🎥'
                });
            } else {
                console.log(`📢 通知: ${message}`);
            }
        }
        
        function updateFilesList() {
            const filesGrid = document.getElementById('filesGrid');
            if (!filesGrid) return;
            
            if (recordingFiles.length === 0) {
                filesGrid.innerHTML = '<div class="card"><span class="icon">📭</span><h4>暫無錄製檔案</h4><p>開始錄製後檔案將顯示在這裡</p></div>';
                document.getElementById('fileCount').textContent = '0 個';
                document.getElementById('storageInfo').textContent = '0 MB / 2 GB';
                return;
            }
            
            filesGrid.innerHTML = recordingFiles.map(file => `
                <div class="card">
                    <span class="icon">${file.isVideo ? '🎬' : (file.type === 'audio' ? '🎵' : '📹')}</span>
                    <h4>${file.name}</h4>
                    <p>${formatDuration(file.duration)} | ${formatFileSize(file.size)}</p>
                    <p style="font-size: 0.8em; opacity: 0.8;">${file.timestamp}</p>
                    <p style="font-size: 0.7em; color: #ffa500;">${file.triggerType || ''}</p>
                    <button class="btn" style="font-size: 0.8em; padding: 8px 16px;" onclick="playFile(${file.id})">${file.isVideo ? '🎬' : '▶️'} 播放</button>
                    <button class="btn" style="font-size: 0.8em; padding: 8px 16px; background: #27ae60;" onclick="downloadFile(${file.id})">⬇️ 下載</button>
                    <button class="btn" style="font-size: 0.8em; padding: 8px 16px; background: #ff4757;" onclick="deleteFile(${file.id})">🗑️ 刪除</button>
                </div>
            `).join('');
            
            // 更新統計
            const totalSize = recordingFiles.reduce((sum, file) => sum + file.size, 0);
            document.getElementById('fileCount').textContent = `${recordingFiles.length} 個`;
            document.getElementById('storageInfo').textContent = `${formatFileSize(totalSize)} / 2 GB`;
        }
        
        function formatDuration(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function playFile(id) {
            const file = recordingFiles.find(f => f.id === id);
            if (!file) return;
            
            if (file.data === 'data:audio/webm;base64,simulated') {
                alert('這是模擬檔案，無法播放。請允許權限以錄製真實媒體。');
                return;
            }
            
            if (file.isVideo) {
                // 播放視頻
                playVideoFile(file);
            } else {
                // 播放音頻
                const audio = new Audio(file.data);
                audio.play().then(() => {
                    console.log(`▶️ 播放音頻: ${file.name}`);
                }).catch(error => {
                    console.error('音頻播放失敗:', error);
                    alert('播放失敗，檔案可能已損壞');
                });
            }
        }
        
        function playVideoFile(file) {
            // 創建全屏視頻播放器
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            `;
            
            const video = document.createElement('video');
            video.src = file.data;
            video.controls = true;
            video.autoplay = true;
            video.style.cssText = `
                max-width: 90%;
                max-height: 70%;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            const title = document.createElement('h3');
            title.textContent = file.name;
            title.style.cssText = `
                color: white;
                margin-bottom: 20px;
                text-align: center;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '❌ 關閉';
            closeBtn.style.cssText = `
                margin-top: 20px;
                padding: 10px 20px;
                background: #ff6b6b;
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
            `;
            
            closeBtn.onclick = () => {
                video.pause();
                overlay.remove();
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    video.pause();
                    overlay.remove();
                }
            };
            
            overlay.appendChild(title);
            overlay.appendChild(video);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);
            
            console.log(`🎬 播放視頻: ${file.name}`);
        }
        
        function downloadFile(id) {
            const file = recordingFiles.find(f => f.id === id);
            if (!file) return;
            
            if (file.data === 'data:audio/webm;base64,simulated') {
                alert('這是模擬檔案，無法下載。');
                return;
            }
            
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`⬇️ 下載: ${file.name}`);
        }
        
        function deleteFile(id) {
            if (confirm('確定要刪除這個檔案嗎？')) {
                recordingFiles = recordingFiles.filter(f => f.id !== id);
                localStorage.setItem('tcldcam_files', JSON.stringify(recordingFiles));
                updateFilesList();
                console.log('🗑️ 檔案已刪除');
            }
        }
        
        function updateDisplay() {
            time++;
            const min = Math.floor(time / 60), sec = time % 60;
            document.getElementById('time').textContent = 
                `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            document.getElementById('volume').textContent = `${Math.floor(Math.random() * 40) + 30} dB`;
            const states = ['偵測中', '發現動態', '分析中'];
            document.getElementById('visual').textContent = states[Math.floor(Math.random() * 3)];
        }
        
        // 更新閾值顯示和背景狀態
        setInterval(() => {
            if (!recording && !audioDetectionActive) {
                document.getElementById('volume').textContent = `${Math.floor(Math.random() * 20) + 10} dB`;
                document.getElementById('debug').textContent = '點擊開始偵測測試麥克風';
            }
            
            // 實時更新閾值顯示
            document.getElementById('thresholdDisplay').textContent = `${detectionSettings.audioThreshold} dB`;
        }, 1000);
        
        // 手機版適配檢查
        function checkMobileCompatibility() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            console.log(`📱 設備檢測: ${isMobile ? '移動設備' : '桌面設備'}`);
            if (isIOS) console.log('🍎 iOS 設備');
            if (isAndroid) console.log('🤖 Android 設備');
            
            // 檢查關鍵 API 支持
            const hasMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const hasAudioContext = !!(window.AudioContext || window.webkitAudioContext);
            const hasNotifications = !!window.Notification;
            
            console.log(`🎤 媒體設備 API: ${hasMediaDevices ? '✅' : '❌'}`);
            console.log(`🔊 音頻上下文 API: ${hasAudioContext ? '✅' : '❌'}`);
            console.log(`🔔 通知 API: ${hasNotifications ? '✅' : '❌'}`);
            
            // 手機版特殊處理
            if (isMobile) {
                // 禁用視口縮放
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
                }
                
                // iOS Safari 特殊處理
                if (isIOS) {
                    // 防止頁面滾動時地址欄消失造成的高度變化
                    document.body.style.height = '100vh';
                    document.body.style.overflow = 'hidden';
                    
                    // 添加 iOS 狀態欄適配
                    document.body.style.paddingTop = 'env(safe-area-inset-top)';
                    document.body.style.paddingBottom = 'env(safe-area-inset-bottom)';
                }
                
                // 觸控反饋優化
                document.addEventListener('touchstart', function(){}, {passive: true});
            }
            
            return {
                isMobile,
                isIOS,
                isAndroid,
                hasMediaDevices,
                hasAudioContext,
                hasNotifications
            };
        }
        
        // 手機版音頻權限處理
        async function requestMobilePermissions() {
            const compatibility = checkMobileCompatibility();
            
            if (compatibility.isMobile) {
                try {
                    // 手機版需要用戶手勢觸發
                    console.log('📱 手機版權限請求準備中...');
                    
                    // 延遲請求，等待用戶交互
                    document.addEventListener('click', async function requestOnFirstClick() {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ 
                                audio: true, 
                                video: false // 手機版先只請求音頻權限
                            });
                            console.log('✅ 手機版音頻權限獲取成功');
                            stream.getTracks().forEach(track => track.stop()); // 立即停止以釋放資源
                            document.removeEventListener('click', requestOnFirstClick);
                        } catch (error) {
                            console.log('⚠️ 手機版音頻權限被拒絕');
                        }
                    }, { once: true });
                    
                } catch (error) {
                    console.error('手機版權限初始化失敗:', error);
                }
            }
            
            // 通知權限
            if (Notification && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        console.log(`🔔 通知權限: ${permission}`);
                    });
                }, 2000); // 延遲請求避免太突兀
            }
        }
        
        // macOS 音頻上下文激活
        function activateAudioContext() {
            if (audioContext && audioContext.state === 'suspended') {
                console.log('🔄 用戶手勢觸發，激活音頻上下文...');
                audioContext.resume().then(() => {
                    console.log('✅ macOS 音頻上下文激活成功！');
                    document.removeEventListener('click', activateAudioContext);
                    document.removeEventListener('touchstart', activateAudioContext);
                }).catch(error => {
                    console.error('❌ 音頻上下文激活失敗:', error);
                });
            }
        }

        // macOS 特殊處理
        function handleMacOSAudio() {
            const isMacOS = navigator.platform.indexOf('Mac') > -1;
            if (isMacOS) {
                console.log('🍎 檢測到 macOS，添加音頻激活監聽器');
                document.addEventListener('click', activateAudioContext);
                document.addEventListener('touchstart', activateAudioContext);
                
                // 顯示 macOS 提示
                setTimeout(() => {
                    if (audioContext && audioContext.state === 'suspended') {
                        alert('🍎 macOS 用戶提示：\n\n為了啟用音頻偵測功能，請：\n1. 確保您已允許麥克風權限\n2. 點擊頁面任意處激活音頻\n3. 檢查 Safari 設定中的麥克風權限');
                    }
                }, 3000);
            }
        }
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', () => {
            checkMobileCompatibility();
            requestMobilePermissions();
            handleMacOSAudio();
            console.log('📱 手機版適配初始化完成');
            console.log('🍎 macOS 相容性檢查完成');
        });
        
        console.log('🚀 TCLDCAM v1.1.7 - 修復監聽循環停止問題版本');
        console.log('✨ 功能列表:');
        console.log('   🎵 真實 dB 音量測量 (RMS + 對數轉換)');
        console.log('   🎯 線性音量觸發系統 (5-80 範圍)');
        console.log('   🎬 自動錄影 + 錄音同步');
        console.log('   📱 手機/桌面 RWD 適配');
        console.log('🔊 使用說明:');
        console.log('   1. 點擊"🎬 開始錄影偵測"並允許權限');
        console.log('   2. 檢查主頁"實時"欄位 RMS 百分比');
        console.log('   3. 在設定中調整閾值 (20-35 建議範圍)');
        console.log('   4. 對著麥克風說話測試觸發功能');
    </script>
</body>
</html>