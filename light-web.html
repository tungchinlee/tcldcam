<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¥ TCLDCAM - æ™ºèƒ½åµæ¸¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; padding: 10px;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; padding: 20px 0; }
        .logo { font-size: 3em; margin-bottom: 10px; }
        .title { font-size: 2em; margin-bottom: 10px; }
        .nav { display: flex; background: rgba(255,255,255,0.1); border-radius: 25px; padding: 5px; margin: 20px 0; }
        .nav-item { flex: 1; text-align: center; padding: 12px; border-radius: 20px; cursor: pointer; font-size: 0.9em; }
        .nav-item.active { background: rgba(255,255,255,0.2); }
        .content { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; min-height: 300px; }
        .btn { background: #ff6b6b; border: none; border-radius: 25px; padding: 15px 30px; color: white; cursor: pointer; font-size: 1.1em; margin: 10px; }
        .btn:hover { background: #ff5252; }
        .btn.active { background: #ff4757; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .status { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin: 15px 0; }
        .row { display: flex; justify-content: space-between; margin: 8px 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .card { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; text-align: center; }
        .icon { font-size: 2em; display: block; margin-bottom: 10px; }
        .hidden { display: none; }
        
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
        @media (max-width: 768px) {
            .container { padding: 5px; }
            .header { padding: 15px 0; }
            .logo { font-size: 2.5em; }
            .title { font-size: 1.8em; }
            .nav { flex-direction: column; padding: 3px; }
            .nav-item { margin: 3px 0; padding: 15px; font-size: 1em; }
            .content { padding: 15px; min-height: 250px; }
            .btn { padding: 12px 25px; font-size: 1em; margin: 8px; }
            .status { padding: 12px; }
            .row { flex-direction: column; text-align: center; margin: 12px 0; }
            .grid { grid-template-columns: 1fr; gap: 10px; }
            .card { padding: 15px; }
        }
        
        @media (max-width: 480px) {
            .container { padding: 3px; }
            .header { padding: 10px 0; }
            .logo { font-size: 2em; }
            .title { font-size: 1.5em; }
            .nav-item { padding: 12px; font-size: 0.9em; }
            .content { padding: 10px; }
            .btn { padding: 10px 20px; font-size: 0.9em; }
            .card { padding: 12px; }
        }
        
        /* è§¸æ§å„ªåŒ– */
        .nav-item, .btn {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* é˜²æ­¢ç¸®æ”¾ */
        input[type="range"], input[type="checkbox"], select {
            -webkit-appearance: none;
            touch-action: manipulation;
        }
        
        input[type="range"] {
            height: 30px;
            background: rgba(255,255,255,0.2);
            border-radius: 15px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #ff6b6b;
            cursor: pointer;
            border: 2px solid white;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 4px;
            position: relative;
        }
        
        input[type="checkbox"]:checked {
            background: #27ae60;
        }
        
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: -2px;
            left: 2px;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        
        select {
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 8px;
            font-size: 16px; /* é˜²æ­¢iOSç¸®æ”¾ */
        }
        
        select option {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ¥</div>
            <h1 class="title">TCLDCAM</h1>
            <p>æ™ºèƒ½è²éŸ³èˆ‡è¦–è¦ºåµæ¸¬</p>
        </div>
        
        <div class="nav">
            <div class="nav-item active" onclick="show('home')">ğŸ  ä¸»é </div>
            <div class="nav-item" onclick="show('settings')">âš™ï¸ è¨­å®š</div>
            <div class="nav-item" onclick="show('files')">ğŸ“ æª”æ¡ˆ</div>
            <div class="nav-item" onclick="show('models')">ğŸ¤– æ¨¡å‹</div>
        </div>
        
        <div id="home" class="content">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ¯ åµæ¸¬æ§åˆ¶</h2>
            <div style="text-align: center;">
                <button id="recordBtn" class="btn" onclick="toggle()">ğŸ¬ é–‹å§‹éŒ„å½±åµæ¸¬</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button id="testRecordBtn" class="btn" onclick="testRecording()" style="background: #27ae60; font-size: 0.9em; padding: 12px 20px;">ğŸ§ª æ¸¬è©¦éŒ„è£½</button>
                <button id="testTriggerBtn" class="btn" onclick="testTrigger()" style="background: #3742fa; font-size: 0.9em; padding: 12px 20px;">ğŸ”¥ æ¸¬è©¦è§¸ç™¼</button>
            </div>
            <div style="text-align: center; margin-top: 10px;">
                <button id="diagnoseMacBtn" class="btn" onclick="diagnoseMacOS()" style="background: #e67e22; font-size: 0.9em; padding: 12px 20px;">ğŸ è¨ºæ–·</button>
                <button id="forceAudioBtn" class="btn" onclick="forceAudioTest()" style="background: #8e44ad; font-size: 0.9em; padding: 12px 20px;">âš¡ å¼·åˆ¶æ¸¬è©¦</button>
            </div>
            
            <div class="status">
                <div class="row"><span>ğŸ“Š ç‹€æ…‹:</span><span id="status">å¾…æ©Ÿä¸­</span></div>
                <div class="row"><span>ğŸµ éŸ³é‡:</span><span id="volume">0 dB</span></div>
                <div class="row"><span>ğŸ‘ï¸ è¦–è¦º:</span><span id="visual">æœªå•Ÿå‹•</span></div>
                <div class="row"><span>â±ï¸ æ™‚é–“:</span><span id="time">00:00</span></div>
                <div class="row"><span>ğŸ” å¯¦æ™‚:</span><span id="debug">é»æ“Šé–‹å§‹åµæ¸¬æ¸¬è©¦éº¥å…‹é¢¨</span></div>
                <div class="row"><span>ğŸ¯ é–¾å€¼:</span><span id="thresholdDisplay">15 dB</span></div>
            </div>
            
            <div class="grid">
                <div class="card">
                    <span class="icon">ğŸµ</span>
                    <h3>è²éŸ³åµæ¸¬</h3>
                    <p>æ™ºèƒ½è­˜åˆ¥ç‰¹å®šè²éŸ³æ¨¡å¼</p>
                </div>
                <div class="card">
                    <span class="icon">ğŸ‘ï¸</span>
                    <h3>è¦–è¦ºåµæ¸¬</h3>
                    <p>AIé©…å‹•çš„ç•«é¢åˆ†æ</p>
                </div>
                <div class="card">
                    <span class="icon">ğŸ“¹</span>
                    <h3>è‡ªå‹•éŒ„è£½</h3>
                    <p>åµæ¸¬åˆ°ç›®æ¨™æ™‚è‡ªå‹•éŒ„è£½</p>
                </div>
                <div class="card">
                    <span class="icon">ğŸ¤–</span>
                    <h3>AIæ¨¡å‹</h3>
                    <p>é›²ç«¯æ›´æ–°èˆ‡æœ¬åœ°ç·©å­˜</p>
                </div>
            </div>
        </div>
        
        <div id="settings" class="content hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">âš™ï¸ åµæ¸¬è¨­å®š</h2>
            <div class="status">
                <h3>ğŸµ è²éŸ³åµæ¸¬è¨­å®š</h3>
                <div class="row"><span>åµæ¸¬é–¾å€¼:</span><span id="audioThresholdValue">15 dB</span></div>
                <input type="range" id="audioThresholdSlider" style="width: 100%; margin: 10px 0;" min="5" max="80" value="15" oninput="updateAudioThreshold(this.value)">
                <div style="display: flex; justify-content: space-between; font-size: 0.8em; opacity: 0.7; margin-top: -5px;">
                    <span>æ¥µéˆæ• (5)</span>
                    <span>ä¸­ç­‰ (25)</span>
                    <span>é«˜é–¾å€¼ (80)</span>
                </div>
                
                <div class="row"><span>æŒçºŒæ™‚é–“:</span><span id="audioDurationValue">2 ç§’</span></div>
                <input type="range" id="audioDurationSlider" style="width: 100%; margin: 10px 0;" min="1" max="10" value="2" oninput="updateAudioDuration(this.value)">
                
                <div class="row">
                    <span>è‡ªå‹•è§¸ç™¼éŒ„è£½:</span>
                    <input type="checkbox" id="audioAutoTrigger" checked onchange="updateAudioAutoTrigger(this.checked)">
                    <span id="audioAutoStatus">âœ… å•Ÿç”¨</span>
                </div>
                
                <h3 style="margin-top: 20px;">ğŸ“¹ éŒ„è£½è¨­å®š</h3>
                <div class="row">
                    <span>åŒæ™‚éŒ„éŸ³éŒ„å½±:</span>
                    <input type="checkbox" id="recordBoth" checked onchange="updateRecordBoth(this.checked)">
                    <span id="recordBothStatus">âœ… å•Ÿç”¨</span>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #ffa500;" id="recordingModeTitle">ğŸ“¹ éŒ„å½±åŠŸèƒ½èªªæ˜</h4>
                    <p style="font-size: 0.9em; line-height: 1.4; margin: 0;" id="recordingModeDesc">â€¢ å•Ÿç”¨å¾Œåµæ¸¬åˆ°è²éŸ³æ™‚æœƒåŒæ™‚éŒ„è£½è¦–é »å’ŒéŸ³é »<br>â€¢ éŒ„å½±è§£æåº¦: 1280x720 @ 30fps<br>â€¢ éœ€è¦é¡å¤–çš„æ”å½±æ©Ÿæ¬Šé™<br>â€¢ æª”æ¡ˆå¤§å°æœƒæ¯”ç´”éŸ³é »å¤§å¾ˆå¤š</p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="resetSettings()">ğŸ”„ é‡ç½®è¨­å®š</button>
                    <button class="btn" onclick="exportSettings()" style="background: #27ae60;">ğŸ“¤ åŒ¯å‡ºè¨­å®š</button>
                </div>
            </div>
        </div>
        
        <div id="files" class="content hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“ éŒ„è£½æª”æ¡ˆ</h2>
            <div class="status">
                <div class="row"><span>ğŸ“Š æª”æ¡ˆæ•¸:</span><span id="fileCount">0 å€‹</span></div>
                <div class="row"><span>ğŸ’¾ ç©ºé–“:</span><span id="storageInfo">0 MB / 2 GB</span></div>
            </div>
            <div class="grid" id="filesGrid">
                <div class="card">
                    <span class="icon">ğŸ“­</span>
                    <h4>æš«ç„¡éŒ„è£½æª”æ¡ˆ</h4>
                    <p>é–‹å§‹éŒ„è£½å¾Œæª”æ¡ˆå°‡é¡¯ç¤ºåœ¨é€™è£¡</p>
                </div>
            </div>
        </div>
        
        <div id="models" class="content hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ¤– AIæ¨¡å‹ç®¡ç†</h2>
            <div class="status">
                <div class="row"><span>ğŸ”„ æœ€å¾Œæ›´æ–°:</span><span id="lastUpdateTime">2025-01-07 14:30</span></div>
                <div class="row"><span>ğŸ“¡ é€£ç·šç‹€æ…‹:</span><span id="connectionStatus" style="color: #27ae60;">âœ… å·²é€£ç·š</span></div>
                <div class="row"><span>ğŸ¯ è‡ªå‹•æ›´æ–°:</span><input type="checkbox" id="autoUpdate" checked onchange="updateAutoUpdate(this.checked)"> <span id="autoUpdateStatus">âœ… å•Ÿç”¨</span></div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" onclick="checkForUpdates()" id="checkUpdatesBtn">ğŸ” æª¢æŸ¥æ›´æ–°</button>
                <button class="btn" onclick="downloadAllModels()" style="background: #27ae60;">ğŸ“¥ ä¸‹è¼‰å…¨éƒ¨</button>
            </div>
            
            <div class="grid" id="modelsGrid">
                <div class="card">
                    <span class="icon">ğŸµ</span>
                    <h4>è²éŸ³è­˜åˆ¥æ¨¡å‹</h4>
                    <p><strong>ç‰ˆæœ¬:</strong> <span id="audioModelVersion">v2.3.1</span></p>
                    <p><strong>ç‹€æ…‹:</strong> <span id="audioModelStatus" style="color: #27ae60;">âœ… å·²è¼‰å…¥</span></p>
                    <p><strong>å¤§å°:</strong> <span id="audioModelSize">15.2 MB</span></p>
                    <p><strong>æº–ç¢ºç‡:</strong> <span id="audioModelAccuracy">94.7%</span></p>
                    <div style="margin: 10px 0;">
                        <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px;">
                            <div style="background: #27ae60; height: 100%; border-radius: 10px; width: 95%;"></div>
                        </div>
                    </div>
                    <button class="btn" onclick="updateModel('audio')" style="font-size: 0.8em; padding: 8px 16px;">ğŸ”„ æ›´æ–°æ¨¡å‹</button>
                    <button class="btn" onclick="testModel('audio')" style="font-size: 0.8em; padding: 8px 16px; background: #3742fa;">ğŸ§ª æ¸¬è©¦</button>
                </div>
            </div>
        </div>
        
        <p style="text-align: center; margin-top: 30px; opacity: 0.7; font-size: 0.9em;">
            ç‰ˆæœ¬ v1.1.7 | ä¿®å¾©ç›£è½å¾ªç’°åœæ­¢å•é¡Œ | 512MB RAMæœ€ä½³åŒ–
        </p>
    </div>
    
    <script>
        let recording = false, time = 0, interval, mediaRecorder, recordedChunks = [], stream;
        let autoStopTimeout; // è‡ªå‹•åœæ­¢éŒ„è£½çš„è¨ˆæ™‚å™¨
        let recordingFiles = JSON.parse(localStorage.getItem('tcldcam_files') || '[]');
        
        // ç²¾ç¢ºçš„éŸ³é »åµæ¸¬è®Šé‡
        let audioDetectionActive = false;
        let visualDetectionActive = false;
        let audioContext, analyser, microphone, dataArray;
        let videoElement, canvas, canvasContext;
        let lastFrameData = null;
        let videoRecordingStream = null;
        
        let detectionSettings = {
            audioThreshold: 15, // é™ä½é è¨­é–¾å€¼ä½¿å…¶æ›´å®¹æ˜“è§¸ç™¼
            audioDuration: 2,
            audioAutoTrigger: true,
            visualSensitivity: 50,
            detectionArea: 'full',
            motionDetection: true,
            autoRecording: true,
            recordBoth: true
        };
        
        function show(tab) {
            document.querySelectorAll('.content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.remove('hidden');
            event.target.classList.add('active');
            
            if (tab === 'files') {
                updateFilesList();
            }
        }
        
        async function toggle() {
            const btn = document.getElementById('recordBtn');
            const status = document.getElementById('status');
            
            if (!audioDetectionActive && !visualDetectionActive) {
                // Start auto detection
                try {
                    await startAutoDetection();
                    btn.textContent = 'â¹ï¸ åœæ­¢åµæ¸¬';
                    btn.classList.add('active');
                    status.textContent = 'ğŸ‘ï¸ğŸµ è‡ªå‹•åµæ¸¬ä¸­';
                    console.log('âœ… è‡ªå‹•åµæ¸¬å·²å•Ÿå‹•');
                } catch (error) {
                    console.log('âš ï¸ æ¬Šé™è¢«æ‹’çµ•ï¼Œä½¿ç”¨æ¨¡æ“¬æ¨¡å¼');
                    startSimulatedDetection();
                    btn.textContent = 'â¹ï¸ åœæ­¢åµæ¸¬';
                    btn.classList.add('active');
                    status.textContent = 'ğŸ‘ï¸ğŸµ æ¨¡æ“¬åµæ¸¬ä¸­';
                }
            } else {
                // Stop auto detection
                if (recording) {
                    // å¦‚æœæ­£åœ¨éŒ„è£½ï¼Œæä¾›æ‰‹å‹•åœæ­¢é¸é …
                    if (confirm('ç›®å‰æ­£åœ¨éŒ„è£½ä¸­ï¼Œç¢ºå®šè¦åœæ­¢åµæ¸¬å’ŒéŒ„è£½å—ï¼Ÿ')) {
                        stopTriggeredRecording(); // å…ˆåœæ­¢éŒ„è£½
                        stopAutoDetection(); // å†åœæ­¢åµæ¸¬
                        btn.textContent = detectionSettings.recordBoth ? 'ğŸ¬ é–‹å§‹éŒ„å½±åµæ¸¬' : 'ğŸ¤ é–‹å§‹éŒ„éŸ³åµæ¸¬';
                        btn.classList.remove('active');
                        status.textContent = 'æ‰‹å‹•åœæ­¢';
                        console.log('âœ‹ ç”¨æˆ¶æ‰‹å‹•åœæ­¢åµæ¸¬å’ŒéŒ„è£½');
                    }
                } else {
                    stopAutoDetection();
                    btn.textContent = detectionSettings.recordBoth ? 'ğŸ¬ é–‹å§‹éŒ„å½±åµæ¸¬' : 'ğŸ¤ é–‹å§‹éŒ„éŸ³åµæ¸¬';
                    btn.classList.remove('active');
                    status.textContent = 'å¾…æ©Ÿä¸­';
                    console.log('â¹ï¸ è‡ªå‹•åµæ¸¬å·²åœæ­¢');
                }
            }
        }
        
        async function startAutoDetection() {
            try {
                console.log('ğŸµ è«‹æ±‚éŸ³é »æ¬Šé™...');
                
                // macOS ç‰¹æ®ŠéŸ³é »é…ç½®
                const isMacOS = navigator.platform.indexOf('Mac') > -1;
                const audioConstraints = {
                    audio: {
                        echoCancellation: false, // macOS Safari å¯èƒ½èˆ‡é€™å€‹æœ‰å•é¡Œ
                        noiseSuppression: false, // é—œé–‰é™å™ªä»¥ç²å¾—æ›´åŸå§‹æ•¸æ“š
                        autoGainControl: false,  // é—œé–‰è‡ªå‹•å¢ç›Šæ§åˆ¶
                        sampleRate: { ideal: 44100 }, // macOS æ¨™æº–é‡‡æ¨£ç‡
                        channelCount: { ideal: 1 },   // å–®è²é“
                    }
                };
                
                console.log(`ğŸ–¥ï¸ ç•¶å‰å¹³å°: ${navigator.platform}`);
                console.log(`ğŸ“± ç”¨æˆ¶ä»£ç†: ${navigator.userAgent.substring(0, 100)}...`);
                
                const audioStream = await navigator.mediaDevices.getUserMedia(
                    isMacOS ? audioConstraints : { audio: true }
                );
                console.log('âœ… éŸ³é »æ¬Šé™ç²å–æˆåŠŸ');
                console.log(`ğŸ¤ éŸ³é »è»Œé“æ•¸é‡: ${audioStream.getAudioTracks().length}`);
                console.log(`ğŸ¤ éŸ³é »è»Œé“è¨­å®š: ${JSON.stringify(audioStream.getAudioTracks()[0].getSettings())}`);
                
                // Setup audio detection first
                if (detectionSettings.audioAutoTrigger) {
                    setupAudioDetection(audioStream);
                    audioDetectionActive = true;
                    console.log('âœ… éŸ³é »åµæ¸¬å·²å•Ÿå‹•');
                }
                
                // Try video separately (might be denied)
                if (detectionSettings.motionDetection) {
                    try {
                        console.log('ğŸ“¹ è«‹æ±‚è¦–é »æ¬Šé™...');
                        const videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
                        console.log('âœ… è¦–é »æ¬Šé™ç²å–æˆåŠŸ');
                        setupVisualDetection(videoStream);
                        visualDetectionActive = true;
                        console.log('âœ… è¦–è¦ºåµæ¸¬å·²å•Ÿå‹•');
                    } catch (videoError) {
                        console.log('âš ï¸ è¦–é »æ¬Šé™è¢«æ‹’çµ•ï¼Œåƒ…ä½¿ç”¨éŸ³é »åµæ¸¬');
                    }
                }
                
                stream = audioStream; // Keep reference for cleanup
                
                console.log(`ğŸµ éŸ³é »é–¾å€¼: ${detectionSettings.audioThreshold} dB`);
                console.log(`ğŸ‘ï¸ è¦–è¦ºéˆæ•åº¦: ${detectionSettings.visualSensitivity}%`);
                console.log(`â±ï¸ éŒ„è£½æ™‚é•·: ${detectionSettings.audioDuration} ç§’`);
                
                // æç¤ºç”¨æˆ¶æ¸¬è©¦
                alert('âœ… é«˜ç²¾åº¦åµæ¸¬ç³»çµ±å·²å•Ÿå‹•ï¼\n\nğŸµ è«‹å°è‘—éº¥å…‹é¢¨èªªè©±æˆ–ç™¼å‡ºè²éŸ³\nğŸ” æª¢æŸ¥ä¸‹æ–¹"å¯¦æ™‚"æ¬„ä½æŸ¥çœ‹ RMS æ•¸å€¼\nğŸ¯ å¯åœ¨è¨­å®šä¸­èª¿æ•´é–¾å€¼ (10-60dB)\nğŸ”§ å»ºè­°å…ˆè©¦ 20-35dB ç¯„åœ');
                
            } catch (error) {
                console.error('è‡ªå‹•åµæ¸¬å•Ÿå‹•å¤±æ•—:', error);
                throw error;
            }
        }
        
        function setupAudioDetection(audioStream) {
            try {
                // macOS Safari ç‰¹æ®Šè™•ç†
                const isMacOS = navigator.platform.indexOf('Mac') > -1;
                const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
                
                console.log(`ğŸ–¥ï¸ å¹³å°æª¢æ¸¬: macOS=${isMacOS}, Safari=${isSafari}`);
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 44100, // macOS åå¥½çš„é‡‡æ¨£ç‡
                    latencyHint: 'interactive' // æ¸›å°‘å»¶é²
                });
                
                console.log(`ğŸµ éŸ³é »ä¸Šä¸‹æ–‡ç‹€æ…‹: ${audioContext.state}`);
                console.log(`ğŸµ é‡‡æ¨£ç‡: ${audioContext.sampleRate} Hz`);
                
                // macOS Safari éœ€è¦ç”¨æˆ¶æ‰‹å‹¢æ¿€æ´»éŸ³é »ä¸Šä¸‹æ–‡
                if (audioContext.state === 'suspended') {
                    console.log('ğŸ”Š éŸ³é »ä¸Šä¸‹æ–‡è¢«æš«åœï¼Œéœ€è¦ç”¨æˆ¶æ‰‹å‹¢æ¿€æ´»...');
                    // ç«‹å³å˜—è©¦æ¢å¾©
                    audioContext.resume().then(() => {
                        console.log('âœ… éŸ³é »ä¸Šä¸‹æ–‡æ¢å¾©æˆåŠŸ');
                    }).catch(error => {
                        console.error('âŒ éŸ³é »ä¸Šä¸‹æ–‡æ¢å¾©å¤±æ•—:', error);
                        alert('âš ï¸ macOS Safari éœ€è¦æ‚¨é»æ“Šé é¢ä»»æ„è™•ä¾†æ¿€æ´»éŸ³é »åµæ¸¬åŠŸèƒ½');
                    });
                }
                
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(audioStream);
                
                // é‡æ–°è¨­å®šåˆ†æå™¨åƒæ•¸ä»¥ç²å¾—æ›´ç²¾ç¢ºçš„éŸ³é‡æ¸¬é‡
                analyser.fftSize = 2048; // æ›´é«˜ç²¾åº¦
                analyser.smoothingTimeConstant = 0.1; // é™ä½å¹³æ»‘åŒ–ä»¥ç²å¾—æ›´å³æ™‚çš„éŸ³é‡
                analyser.minDecibels = -90;
                analyser.maxDecibels = -10;
                
                const bufferLength = analyser.fftSize; // ä½¿ç”¨æ™‚åŸŸæ•¸æ“šé•·åº¦
                dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                console.log('ğŸµ éŸ³é »åµæ¸¬åˆå§‹åŒ–æˆåŠŸ');
                console.log(`   - FFT å¤§å°: ${analyser.fftSize}`);
                console.log(`   - ç·©è¡å€é•·åº¦: ${bufferLength}`);
                console.log(`   - æ¨£æœ¬ç‡: ${audioContext.sampleRate} Hz`);
                console.log(`   - éŸ³é »ç¯„åœ: ${analyser.minDecibels} åˆ° ${analyser.maxDecibels} dB`);
                console.log(`   - å¹³æ»‘åŒ–: ${analyser.smoothingTimeConstant}`);
                console.log(`   - éŸ³é »ä¸Šä¸‹æ–‡ç‹€æ…‹: ${audioContext.state}`);
                
                // Start audio monitoring - å¼·åˆ¶å•Ÿå‹•
                console.log('ğŸš€ å¼·åˆ¶å•Ÿå‹•éŸ³é »ç›£è½å¾ªç’°...');
                monitorAudio();
                
                // å‚™ç”¨ç›£è½å™¨ - ç¢ºä¿ä¸€å®šæœ‰ç›£è½åœ¨é‹è¡Œ
                setInterval(() => {
                    if (audioDetectionActive && analyser && audioContext && audioContext.state === 'running') {
                        // æª¢æŸ¥ç›£è½æ˜¯å¦é‚„åœ¨é‹è¡Œ
                        const currentTime = Date.now();
                        if (!window.lastAudioCheck || currentTime - window.lastAudioCheck > 3000) {
                            console.log('ğŸ”„ å‚™ç”¨ç›£è½å™¨æª¢æ¸¬åˆ°ç›£è½å¯èƒ½åœæ­¢ï¼Œé‡æ–°å•Ÿå‹•...');
                            monitorAudio();
                        }
                    }
                }, 2000);
                
            } catch (error) {
                console.error('éŸ³é »åµæ¸¬åˆå§‹åŒ–å¤±æ•—:', error);
                throw error;
            }
        }
        
        function monitorAudio() {
            if (!audioDetectionActive || !analyser) {
                if (!audioDetectionActive) console.log('âš ï¸ audioDetectionActive = false, åœæ­¢ç›£è½');
                if (!analyser) console.log('âš ï¸ analyser æœªåˆå§‹åŒ–, åœæ­¢ç›£è½');
                return;
            }
            
            // macOS Safari éŸ³é »ä¸Šä¸‹æ–‡ç‹€æ…‹æª¢æŸ¥
            if (audioContext && audioContext.state !== 'running') {
                console.log(`âš ï¸ éŸ³é »ä¸Šä¸‹æ–‡ç‹€æ…‹: ${audioContext.state}, å˜—è©¦æ¢å¾©ä¸¦ç¹¼çºŒç›£è½...`);
                audioContext.resume();
                // ç¹¼çºŒç›£è½ï¼Œä¸è¦åœæ­¢
                requestAnimationFrame(monitorAudio);
                return;
            }
            
            try {
                // å¿ƒè·³æª¢æ¸¬ - è¨˜éŒ„ç›£è½å™¨é‚„åœ¨é‹è¡Œ
                window.lastAudioCheck = Date.now();
                
                // ä½¿ç”¨æ™‚åŸŸæ•¸æ“šç²å¾—çœŸå¯¦çš„éŸ³é‡æ¸¬é‡
                analyser.getByteTimeDomainData(dataArray);
                
                // è¨ˆç®—çœŸæ­£çš„ RMS éŸ³é‡
                let sum = 0;
                for (let i = 0; i < dataArray.length; i++) {
                    const amplitude = (dataArray[i] - 128) / 128; // æ­£è¦åŒ–åˆ° -1 åˆ° 1
                    sum += amplitude * amplitude;
                }
                const rms = Math.sqrt(sum / dataArray.length);
                
                // æ–°çš„å¯¦ç”¨éŸ³é »æ¸¬é‡ç³»çµ± - ä½¿ç”¨ç™¾åˆ†æ¯”æ–¹å¼
                const volumePercentage = Math.floor(rms * 100); // 0-100% éŸ³é‡
                
                // å‚³çµ± dB è½‰æ›ä½œç‚ºåƒè€ƒ
                const traditionalDb = rms > 0.001 ? Math.max(0, Math.min(100, 20 * Math.log10(rms) + 80)) : 0;
                
                // ä½¿ç”¨ç¯„åœ 0-100 çš„ç·šæ€§éŸ³é‡å€¼ï¼Œæ›´ç›´è§€
                const linearVolume = Math.floor(Math.sqrt(rms) * 100); // å¹³æ–¹æ ¹è½‰æ›ï¼Œæ›´åˆç†
                const displayVolumeDb = Math.max(volumePercentage, linearVolume); // å–è¼ƒé«˜å€¼
                
                // Update volume display with more intuitive values
                document.getElementById('volume').textContent = `${displayVolumeDb} dB`;
                
                // ä½¿ç”¨æ–°çš„éŸ³é‡ç³»çµ±é€²è¡Œé–¾å€¼æ¯”è¼ƒ
                const thresholdMet = displayVolumeDb >= detectionSettings.audioThreshold;
                
                // å¯¦æ™‚é™¤éŒ¯è³‡è¨Š - æ›´è©³ç´°çš„ç‹€æ…‹
                const debugText = `${thresholdMet ? 'ğŸ”¥è§¸ç™¼' : 'â­•æœªè§¸ç™¼'} ${displayVolumeDb}/${detectionSettings.audioThreshold}dB [RMS:${(rms*1000).toFixed(1)}]`;
                document.getElementById('debug').textContent = debugText;
                
                // åŠ å¼·çš„é™¤éŒ¯è¨˜éŒ„
                if (displayVolumeDb > 3) { // é™ä½é–€æª»
                    const status = thresholdMet ? 'ğŸ”¥è§¸ç™¼' : 'â­•ç„¡è§¸ç™¼';
                    const autoStatus = detectionSettings.audioAutoTrigger ? 'âœ…ON' : 'âŒOFF';
                    console.log(`ğŸµ ${status}: ${displayVolumeDb}dB>=${detectionSettings.audioThreshold}dB, RMS=${(rms*1000).toFixed(2)}, è‡ªå‹•éŒ„è£½:${autoStatus}, éŒ„è£½ä¸­:${recording}`);
                }
                
                // åŠ å¼·è§¸ç™¼æª¢æŸ¥
                if (thresholdMet) {
                    console.log(`ğŸš¨ éŸ³é »é–¾å€¼é”åˆ°! ç«‹å³èª¿ç”¨ triggerAudioDetection(${displayVolumeDb})`);
                    triggerAudioDetection(displayVolumeDb);
                } else if (displayVolumeDb > detectionSettings.audioThreshold * 0.8) {
                    // æ¥è¿‘é–¾å€¼æ™‚çš„æç¤º
                    console.log(`ğŸŸ¡ æ¥è¿‘é–¾å€¼: ${displayVolumeDb}dB (${(displayVolumeDb/detectionSettings.audioThreshold*100).toFixed(0)}%)`);
                }
                
            } catch (error) {
                console.error('âŒ éŸ³é »åˆ†æéŒ¯èª¤:', error);
                console.error('éŒ¯èª¤è©³æƒ…:', error.message);
                // å³ä½¿å‡ºéŒ¯ä¹Ÿè¦ç¹¼çºŒç›£è½
            }
            
            // å¼·åˆ¶ç¹¼çºŒç›£è½ - ç„¡è«–å¦‚ä½•éƒ½è¦ç¹¼çºŒ
            if (audioDetectionActive) {
                requestAnimationFrame(monitorAudio);
            } else {
                console.log('ğŸ›‘ audioDetectionActive = false, åœæ­¢ç›£è½å¾ªç’°');
            }
        }
        
        let lastTriggerTime = 0;
        
        function triggerAudioDetection(volume) {
            const now = Date.now();
            // é™ä½é˜²æŠ–é–“éš”åˆ° 1 ç§’ï¼Œé¿å…éŒ¯éè§¸ç™¼
            if (now - lastTriggerTime < 1000) {
                console.log(`â±ï¸ è§¸ç™¼é˜²æŠ–ä¸­ï¼Œè·é›¢ä¸Šæ¬¡è§¸ç™¼ ${now - lastTriggerTime}ms`);
                return;
            }
            lastTriggerTime = now;
            
            const status = document.getElementById('status');
            status.textContent = `ğŸ”¥ éŸ³é »è§¸ç™¼! (${volume} dB)`;
            console.log(`ğŸ”¥ éŸ³é »åµæ¸¬è§¸ç™¼: ${volume} dB (é–¾å€¼: ${detectionSettings.audioThreshold}dB)`)
            console.log(`ğŸ“Š ç•¶å‰ç‹€æ…‹: audioAutoTrigger=${detectionSettings.audioAutoTrigger}, recording=${recording}, audioDetectionActive=${audioDetectionActive}`);
            
            // è¦–è¦ºç‰¹æ•ˆï¼šç‹€æ…‹æ¬„é–ƒçˆ
            status.style.background = 'linear-gradient(45deg, #ff6b6b, #ff4757)';
            status.style.transform = 'scale(1.05)';
            status.style.transition = 'all 0.3s ease';
            
            // éŸ³æ•ˆæç¤ºï¼ˆå¦‚æœæ”¯æŒï¼‰
            if (typeof Audio !== 'undefined') {
                try {
                    // ç”¨ Web Audio API ç”Ÿæˆç°¡å–®æç¤ºéŸ³
                    if (audioContext && audioContext.state === 'running') {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.frequency.value = 800; // 800Hz éŸ³é »
                        gainNode.gain.value = 0.1; // ä½éŸ³é‡
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.1); // 0.1ç§’çŸ­éŸ³
                    }
                } catch (e) {
                    console.log('ç„¡æ³•æ’­æ”¾æç¤ºéŸ³');
                }
            }
            
            // ç«‹å³è§¸ç™¼éŒ„éŸ³ï¼Œç„¡å»¶é²
            if (detectionSettings.audioAutoTrigger) {
                if (recording) {
                    console.log(`âš ï¸ å·²åœ¨éŒ„è£½ä¸­ï¼Œé‡è¨­è¨ˆæ™‚å™¨ (è§¸ç™¼å€¼: ${volume}dB)`);
                    // é‡è¨­éŒ„è£½è¨ˆæ™‚å™¨ï¼Œå»¶é•·éŒ„è£½æ™‚é–“
                    if (autoStopTimeout) {
                        clearTimeout(autoStopTimeout);
                    }
                    autoStopTimeout = setTimeout(() => {
                        if (recording) {
                            console.log('â° å»¶é•·éŒ„è£½æ™‚é–“çµæŸï¼Œè‡ªå‹•åœæ­¢');
                            stopTriggeredRecording();
                        }
                    }, detectionSettings.audioDuration * 1000);
                } else {
                    console.log(`ğŸš€ ç«‹å³è§¸ç™¼è‡ªå‹•éŒ„è£½ (${volume}dB >= ${detectionSettings.audioThreshold}dB)`);
                    // ç«‹å³è§¸ç™¼ï¼Œç„¡å»¶é²
                    try {
                        startTriggeredRecording('audio', volume);
                    } catch (error) {
                        console.error('âŒ è‡ªå‹•éŒ„è£½è§¸ç™¼å¤±æ•—:', error);
                    }
                }
            } else {
                console.log('âš ï¸ è‡ªå‹•è§¸ç™¼åŠŸèƒ½å·²é—œé–‰ï¼Œåƒ…æç¤ºåµæ¸¬åˆ°è²éŸ³');
            }
            
            // Reset status after 3 seconds
            setTimeout(() => {
                if (audioDetectionActive) {
                    status.textContent = 'ğŸ‘ï¸ğŸµ è‡ªå‹•åµæ¸¬ä¸­';
                    status.style.background = '';
                    status.style.transform = '';
                }
            }, 3000);
        }
        
        // Settings page functions
        function updateAudioThreshold(value) {
            document.getElementById('audioThresholdValue').textContent = `${value} dB`;
            detectionSettings.audioThreshold = parseInt(value);
            
            // è¨ˆç®—å°æ‡‰çš„ RMS é–¾å€¼
            const thresholdRms = Math.pow(10, (value - 60) / 20);
            console.log(`ğŸµ éŸ³é »é–¾å€¼è¨­å®šç‚º: ${value} dB (RMS é–¾å€¼: ${(thresholdRms * 100).toFixed(2)}%)`);
            
            // æä¾›è¨­å®šå»ºè­°
            if (value < 20) {
                console.log('âš ï¸ é–¾å€¼å¤ªä½ï¼Œå¯èƒ½æœƒé »ç¹è§¸ç™¼');
            } else if (value > 50) {
                console.log('âš ï¸ é–¾å€¼å¤ªé«˜ï¼Œå¯èƒ½é›£ä»¥è§¸ç™¼');
            }
        }
        
        function updateAudioDuration(value) {
            document.getElementById('audioDurationValue').textContent = `${value} ç§’`;
            detectionSettings.audioDuration = parseInt(value);
            
            if (detectionSettings.recordBoth) {
                console.log(`â±ï¸ éŒ„å½±æŒçºŒæ™‚é–“è¨­å®šç‚º: ${value} ç§’`);
            } else {
                console.log(`â±ï¸ éŒ„éŸ³æŒçºŒæ™‚é–“è¨­å®šç‚º: ${value} ç§’ (åƒ…éŒ„éŸ³æ¨¡å¼ï¼Œå¯æ‰‹å‹•åœæ­¢)`);
            }
        }
        
        function updateAudioAutoTrigger(checked) {
            document.getElementById('audioAutoStatus').textContent = checked ? 'âœ… å•Ÿç”¨' : 'âŒ é—œé–‰';
            detectionSettings.audioAutoTrigger = checked;
            console.log(`ğŸ”„ éŸ³é »è‡ªå‹•è§¸ç™¼éŒ„è£½: ${checked ? 'å•Ÿç”¨' : 'é—œé–‰'}`);
            
            if (!checked) {
                console.log('âš ï¸ è‡ªå‹•è§¸ç™¼éŒ„è£½å·²é—œé–‰ï¼Œåµæ¸¬åˆ°è²éŸ³æ™‚åªæœƒé¡¯ç¤ºæç¤ºï¼Œä¸æœƒè‡ªå‹•é–‹å§‹éŒ„è£½');
            } else {
                console.log('âœ… è‡ªå‹•è§¸ç™¼éŒ„è£½å·²å•Ÿç”¨ï¼Œåµæ¸¬åˆ°è²éŸ³æ™‚æœƒè‡ªå‹•é–‹å§‹éŒ„è£½');
            }
        }
        
        function updateRecordBoth(checked) {
            document.getElementById('recordBothStatus').textContent = checked ? 'âœ… å•Ÿç”¨' : 'âŒ é—œé–‰';
            detectionSettings.recordBoth = checked;
            console.log(`ğŸ¥ğŸµ åŒæ™‚éŒ„éŸ³éŒ„å½±: ${checked ? 'å•Ÿç”¨' : 'é—œé–‰'}`);
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—æç¤º
            const recordBtn = document.getElementById('recordBtn');
            if (recordBtn && !audioDetectionActive) {
                recordBtn.innerHTML = checked ? 'ğŸ¬ é–‹å§‹éŒ„å½±åµæ¸¬' : 'ğŸ¤ é–‹å§‹éŒ„éŸ³åµæ¸¬';
            }
            
            // å‹•æ…‹æ›´æ–°åŠŸèƒ½èªªæ˜
            const titleElement = document.getElementById('recordingModeTitle');
            const descElement = document.getElementById('recordingModeDesc');
            
            if (checked) {
                titleElement.textContent = 'ğŸ“¹ éŒ„å½±åŠŸèƒ½èªªæ˜';
                descElement.innerHTML = 'â€¢ å•Ÿç”¨å¾Œåµæ¸¬åˆ°è²éŸ³æ™‚æœƒåŒæ™‚éŒ„è£½è¦–é »å’ŒéŸ³é »<br>â€¢ éŒ„å½±è§£æåº¦: 1280x720 @ 30fps<br>â€¢ éœ€è¦é¡å¤–çš„æ”å½±æ©Ÿæ¬Šé™<br>â€¢ æª”æ¡ˆå¤§å°æœƒæ¯”ç´”éŸ³é »å¤§å¾ˆå¤š<br>â€¢ è‡ªå‹•åœæ­¢æ™‚é–“ç”±"æŒçºŒæ™‚é–“"è¨­å®šæ±ºå®š';
            } else {
                titleElement.textContent = 'ğŸ¤ ç´”éŒ„éŸ³åŠŸèƒ½èªªæ˜';
                descElement.innerHTML = 'â€¢ é—œé–‰éŒ„å½±å¾Œï¼Œåƒ…éŒ„è£½éŸ³é »<br>â€¢ æ–‡ä»¶è¼ƒå°ï¼Œç¯€çœå„²å­˜ç©ºé–“<br>â€¢ ä¸éœ€æ”å½±æ©Ÿæ¬Šé™<br>â€¢ <strong>éŒ„éŸ³å°‡æŒçºŒé€²è¡Œç›´åˆ°æ‰‹å‹•åœæ­¢æˆ–é”åˆ°æœ€é•·æ™‚é–“</strong><br>â€¢ å¯é€é"åœæ­¢åµæ¸¬"æŒ‰éˆ•æ‰‹å‹•ä¸­æ–·éŒ„è£½';
            }
        }
        
        function resetSettings() {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰è¨­å®šå—ï¼Ÿ')) {
                // Reset all sliders and checkboxes
                document.getElementById('audioThresholdSlider').value = 30;
                document.getElementById('audioDurationSlider').value = 2;
                document.getElementById('audioAutoTrigger').checked = true;
                document.getElementById('recordBoth').checked = true;
                
                // Update displays
                updateAudioThreshold(30);
                updateAudioDuration(2);
                updateAudioAutoTrigger(true);
                updateRecordBoth(true);
                
                console.log('ğŸ”„ è¨­å®šå·²é‡ç½®ç‚ºé è¨­å€¼');
                alert('âœ… è¨­å®šå·²é‡ç½®ç‚ºé è¨­å€¼');
            }
        }
        
        function exportSettings() {
            const settings = {
                audioThreshold: document.getElementById('audioThresholdSlider').value,
                audioDuration: document.getElementById('audioDurationSlider').value,
                audioAutoTrigger: document.getElementById('audioAutoTrigger').checked,
                recordBoth: document.getElementById('recordBoth').checked,
                exportTime: new Date().toLocaleString('zh-TW')
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TCLDCAM_è¨­å®š_${new Date().toISOString().substring(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ğŸ“¤ è¨­å®šå·²åŒ¯å‡º');
            alert('âœ… è¨­å®šæª”æ¡ˆå·²ä¸‹è¼‰');
        }
        
        // Models page functions
        function updateAutoUpdate(checked) {
            document.getElementById('autoUpdateStatus').textContent = checked ? 'âœ… å•Ÿç”¨' : 'âŒ é—œé–‰';
            console.log(`ğŸ¤– è‡ªå‹•æ›´æ–°: ${checked ? 'å•Ÿç”¨' : 'é—œé–‰'}`);
        }
        
        function checkForUpdates() {
            const btn = document.getElementById('checkUpdatesBtn');
            btn.textContent = 'ğŸ”„ æª¢æŸ¥ä¸­...';
            btn.disabled = true;
            
            // æ¨¡æ“¬æª¢æŸ¥æ›´æ–°
            setTimeout(() => {
                const hasUpdates = Math.random() > 0.5;
                if (hasUpdates) {
                    alert('ğŸ‰ ç™¼ç¾æ–°ç‰ˆæœ¬ï¼\n\nè²éŸ³è­˜åˆ¥æ¨¡å‹: v2.3.1 â†’ v2.3.2\n\né»æ“Šç¢ºå®šé–‹å§‹ä¸‹è¼‰æ›´æ–°ã€‚');
                    document.getElementById('audioModelVersion').textContent = 'v2.3.2';
                } else {
                    alert('âœ… æ‰€æœ‰æ¨¡å‹å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                }
                document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('zh-TW').substring(0,16);
                btn.textContent = 'ğŸ” æª¢æŸ¥æ›´æ–°';
                btn.disabled = false;
            }, 2000);
        }
        
        function downloadAllModels() {
            if (confirm('ç¢ºå®šè¦ä¸‹è¼‰æ‰€æœ‰æ¨¡å‹å—ï¼Ÿé€™å°‡éœ€è¦ç´„ 84MB çš„ç©ºé–“ã€‚')) {
                alert('ğŸ“¥ é–‹å§‹ä¸‹è¼‰æ‰€æœ‰æ¨¡å‹...\n\né è¨ˆéœ€è¦ 2-3 åˆ†é˜å®Œæˆ\nè«‹ä¿æŒç¶²è·¯é€£ç·šç©©å®š');
                console.log('ğŸ“¥ é–‹å§‹ä¸‹è¼‰æ‰€æœ‰AIæ¨¡å‹');
            }
        }
        
        function updateModel(type) {
            const models = {
                'audio': 'è²éŸ³è­˜åˆ¥æ¨¡å‹'
            };
            
            if (confirm(`ç¢ºå®šè¦æ›´æ–°${models[type]}å—ï¼Ÿ`)) {
                alert(`ğŸ”„ æ­£åœ¨æ›´æ–°${models[type]}...\n\nä¸‹è¼‰é€²åº¦å°‡åœ¨æ§åˆ¶å°é¡¯ç¤º`);
                console.log(`ğŸ”„ é–‹å§‹æ›´æ–° ${models[type]}`);
                
                // Simulate update progress
                setTimeout(() => {
                    console.log(`âœ… ${models[type]} æ›´æ–°å®Œæˆ`);
                    alert(`âœ… ${models[type]} æ›´æ–°æˆåŠŸï¼`);
                }, 3000);
            }
        }
        
        function testRecording() {
            if (recording) {
                console.log('âš ï¸ å·²åœ¨éŒ„è£½ä¸­ï¼Œç„¡æ³•æ¸¬è©¦');
                alert('ç›®å‰å·²åœ¨éŒ„è£½ä¸­ï¼Œè«‹ç­‰å¾…çµæŸå¾Œå†æ¸¬è©¦');
                return;
            }
            
            console.log('ğŸ§ª é–‹å§‹æ¸¬è©¦éŒ„è£½åŠŸèƒ½...');
            const status = document.getElementById('status');
            status.textContent = 'ğŸ§ª æ¸¬è©¦éŒ„è£½ä¸­...';
            
            // ç›´æ¥èª¿ç”¨éŒ„è£½å‡½æ•¸æ¸¬è©¦
            startTriggeredRecording('test', 50)
                .then(() => {
                    console.log('âœ… æ¸¬è©¦éŒ„è£½å•Ÿå‹•æˆåŠŸ');
                })
                .catch(error => {
                    console.error('âŒ æ¸¬è©¦éŒ„è£½å¤±æ•—:', error);
                    alert(`æ¸¬è©¦éŒ„è£½å¤±æ•—: ${error.message}\n\nè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™è¨­å®šã€‚`);
                });
        }
        
        function forceAudioTest() {
            console.log('âš¡ å¼·åˆ¶éŸ³é »æ¸¬è©¦é–‹å§‹...');
            
            // å¼·åˆ¶æª¢æŸ¥æ‰€æœ‰é—œéµè®Šé‡
            console.log(`ğŸ” å…¨é¢æª¢æŸ¥:`);
            console.log(`   audioDetectionActive: ${audioDetectionActive}`);
            console.log(`   analyser: ${analyser ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}`);
            console.log(`   audioContext: ${audioContext ? audioContext.state : 'æœªåˆå§‹åŒ–'}`);
            console.log(`   stream: ${stream ? 'å·²é€£æ¥' : 'æœªé€£æ¥'}`);
            console.log(`   audioAutoTrigger: ${detectionSettings.audioAutoTrigger}`);
            console.log(`   audioThreshold: ${detectionSettings.audioThreshold}dB`);
            
            if (audioDetectionActive && analyser) {
                console.log('ğŸ”¥ å¼·åˆ¶åŸ·è¡Œä¸€æ¬¡éŸ³é »åˆ†æ...');
                
                // å¼·åˆ¶åŸ·è¡Œä¸€æ¬¡ç›£è½å¾ªç’°
                try {
                    analyser.getByteTimeDomainData(dataArray);
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        const amplitude = (dataArray[i] - 128) / 128;
                        sum += amplitude * amplitude;
                    }
                    const rms = Math.sqrt(sum / dataArray.length);
                    const volumePercentage = Math.floor(rms * 100);
                    const linearVolume = Math.floor(Math.sqrt(rms) * 100);
                    const displayVolumeDb = Math.max(volumePercentage, linearVolume);
                    
                    console.log(`âš¡ å¼·åˆ¶æ¸¬è©¦çµæœ: ${displayVolumeDb}dB (RMS: ${(rms*1000).toFixed(2)})`);
                    
                    // å¼·åˆ¶æ›´æ–°UI
                    document.getElementById('volume').textContent = `${displayVolumeDb} dB`;
                    document.getElementById('debug').textContent = `âš¡å¼·åˆ¶æ¸¬è©¦: ${displayVolumeDb}/${detectionSettings.audioThreshold}dB`;
                    
                    // å¼·åˆ¶è§¸ç™¼æ¸¬è©¦ï¼ˆå¦‚æœè¶…éé–¾å€¼ï¼‰
                    if (displayVolumeDb >= detectionSettings.audioThreshold) {
                        console.log('ğŸš¨ å¼·åˆ¶æ¸¬è©¦è§¸ç™¼æ¢ä»¶æ»¿è¶³ï¼Œç«‹å³è§¸ç™¼ï¼');
                        triggerAudioDetection(displayVolumeDb);
                    }
                    
                    alert(`âš¡ å¼·åˆ¶æ¸¬è©¦å®Œæˆ\n\néŸ³é‡: ${displayVolumeDb}dB\né–¾å€¼: ${detectionSettings.audioThreshold}dB\n${displayVolumeDb >= detectionSettings.audioThreshold ? 'âœ… æ‡‰è©²è§¸ç™¼' : 'âŒ æœªé”é–¾å€¼'}`);
                    
                } catch (error) {
                    console.error('âŒ å¼·åˆ¶æ¸¬è©¦å¤±æ•—:', error);
                    alert(`âŒ å¼·åˆ¶æ¸¬è©¦å¤±æ•—: ${error.message}`);
                }
            } else {
                alert('âŒ ç„¡æ³•é€²è¡Œå¼·åˆ¶æ¸¬è©¦\nè«‹å…ˆå•Ÿå‹•éŸ³é »åµæ¸¬åŠŸèƒ½');
            }
            
            // é‡æ–°å•Ÿå‹•ç›£è½å¾ªç’°
            if (audioDetectionActive && analyser) {
                console.log('ğŸ”„ é‡æ–°å•Ÿå‹•ç›£è½å¾ªç’°...');
                monitorAudio();
            }
        }
        
        function diagnoseMacOS() {
            console.log('ğŸ é–‹å§‹ macOS éŸ³é »è¨ºæ–·...');
            
            const isMacOS = navigator.platform.indexOf('Mac') > -1;
            const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
            const isChrome = navigator.userAgent.indexOf('Chrome') > -1;
            
            let diagnosis = 'ğŸ macOS éŸ³é »è¨ºæ–·å ±å‘Š\n\n';
            diagnosis += `ğŸ–¥ï¸ å¹³å°: ${navigator.platform}\n`;
            diagnosis += `ğŸŒ ç€è¦½å™¨: ${isSafari ? 'Safari' : isChrome ? 'Chrome' : 'Other'}\n`;
            diagnosis += `ğŸ“± ç”¨æˆ¶ä»£ç†: ${navigator.userAgent.substring(0, 80)}...\n\n`;
            
            // éŸ³é »ä¸Šä¸‹æ–‡æª¢æŸ¥
            if (audioContext) {
                diagnosis += `ğŸµ éŸ³é »ä¸Šä¸‹æ–‡ç‹€æ…‹: ${audioContext.state}\n`;
                diagnosis += `ğŸµ é‡‡æ¨£ç‡: ${audioContext.sampleRate} Hz\n`;
                diagnosis += `ğŸµ åµæ¸¬æ´»å‹•: ${audioDetectionActive ? 'âœ… æ˜¯' : 'âŒ å¦'}\n`;
            } else {
                diagnosis += `âŒ éŸ³é »ä¸Šä¸‹æ–‡æœªåˆå§‹åŒ–\n`;
            }
            
            // æ¬Šé™æª¢æŸ¥
            if (navigator.mediaDevices) {
                navigator.permissions.query({ name: 'microphone' }).then(result => {
                    diagnosis += `ğŸ¤ éº¥å…‹é¢¨æ¬Šé™: ${result.state}\n`;
                    console.log(diagnosis);
                    alert(diagnosis + '\nğŸ“‹ è©³ç´°ä¿¡æ¯å·²è¼¸å‡ºåˆ° Console');
                }).catch(() => {
                    console.log(diagnosis);
                    alert(diagnosis + '\nğŸ“‹ è©³ç´°ä¿¡æ¯å·²è¼¸å‡ºåˆ° Console');
                });
            } else {
                diagnosis += `âŒ MediaDevices API ä¸å¯ç”¨\n`;
                console.log(diagnosis);
                alert(diagnosis);
            }
            
            // æ¸¬è©¦éŸ³é »ä¸Šä¸‹æ–‡æ¿€æ´»
            if (audioContext && audioContext.state === 'suspended') {
                diagnosis += `\nğŸ’¡ å»ºè­°: é»æ“Šé é¢ä»»æ„è™•æ¿€æ´»éŸ³é »ä¸Šä¸‹æ–‡`;
                audioContext.resume().then(() => {
                    console.log('âœ… è¨ºæ–·éç¨‹ä¸­æˆåŠŸæ¿€æ´»éŸ³é »ä¸Šä¸‹æ–‡');
                });
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æ´»å‹•çš„éŸ³é »è»Œé“
            if (stream && stream.getAudioTracks().length > 0) {
                const track = stream.getAudioTracks()[0];
                diagnosis += `ğŸ¤ éŸ³é »è»Œé“ç‹€æ…‹: ${track.readyState}\n`;
                diagnosis += `ğŸ¤ éŸ³é »è»Œé“è¨­å®š: ${JSON.stringify(track.getSettings())}\n`;
            }
        }
        
        function testTrigger() {
            console.log('ğŸ”¥ æ‰‹å‹•æ¸¬è©¦éŸ³é »è§¸ç™¼é‚è¼¯...');
            console.log(`ğŸ¯ ç•¶å‰è¨­å®š: audioAutoTrigger=${detectionSettings.audioAutoTrigger}, audioThreshold=${detectionSettings.audioThreshold}dB`);
            console.log(`ğŸ“Š ç•¶å‰ç‹€æ…‹: audioDetectionActive=${audioDetectionActive}, recording=${recording}`);
            
            if (!audioDetectionActive) {
                alert('è«‹å…ˆé»æ“Šã€Œé–‹å§‹éŒ„å½±åµæ¸¬ã€å•Ÿå‹•åµæ¸¬åŠŸèƒ½ï¼Œç„¶å¾Œå†æ¸¬è©¦è§¸ç™¼ã€‚');
                return;
            }
            
            // æ¨¡æ“¬è§¸ç™¼éŸ³é »åµæ¸¬
            const testVolume = detectionSettings.audioThreshold + 10; // è¶…éé–¾å€¼10dB
            console.log(`ğŸ§ª æ¨¡æ“¬éŸ³é »è§¸ç™¼: ${testVolume}dB (é–¾å€¼: ${detectionSettings.audioThreshold}dB)`);
            console.log(`ğŸ”§ æª¢æŸ¥æ¸…å–®:`);
            console.log(`   - åµæ¸¬å·²å•Ÿå‹•: ${audioDetectionActive ? 'âœ…' : 'âŒ'}`);
            console.log(`   - è‡ªå‹•è§¸ç™¼: ${detectionSettings.audioAutoTrigger ? 'âœ…' : 'âŒ'}`);
            console.log(`   - ç›®å‰éŒ„è£½ä¸­: ${recording ? 'âœ…' : 'âŒ'}`);
            
            alert(`ğŸ§ª æ¸¬è©¦è§¸ç™¼é–‹å§‹ï¼\n\nè¨­å®šæª¢æŸ¥:\nâœ… åµæ¸¬æ´»å‹•: ${audioDetectionActive}\nâœ… è‡ªå‹•è§¸ç™¼: ${detectionSettings.audioAutoTrigger}\nâœ… æ¸¬è©¦éŸ³é‡: ${testVolume}dB\nâœ… é–¾å€¼è¨­å®š: ${detectionSettings.audioThreshold}dB\n\nè«‹è§€å¯Ÿ Console å’Œç‹€æ…‹é¡¯ç¤ºçš„è®ŠåŒ–ã€‚`);
            
            // ç«‹å³è§¸ç™¼æ¸¬è©¦
            triggerAudioDetection(testVolume);
            
            // 3ç§’å¾Œå†æ¬¡é¡¯ç¤ºçµæœ
            setTimeout(() => {
                const success = recording || (Date.now() - lastTriggerTime < 5000);
                console.log(`ğŸ§ª æ¸¬è©¦çµæœ: ${success ? 'âœ… è§¸ç™¼æˆåŠŸ' : 'âŒ è§¸ç™¼å¤±æ•—'}`);
                alert(`ğŸ§ª æ¸¬è©¦çµæœ: ${success ? 'âœ… è§¸ç™¼æˆåŠŸï¼Œå·²é–‹å§‹éŒ„è£½' : 'âŒ è§¸ç™¼å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š'}`);
            }, 3000);
        }
        
        function testModel(type) {
            const models = {
                'audio': 'è²éŸ³è­˜åˆ¥æ¨¡å‹'
            };
            
            alert(`ğŸ§ª é–‹å§‹æ¸¬è©¦${models[type]}...\n\næ¸¬è©¦çµæœå°‡åœ¨ 5 ç§’å¾Œé¡¯ç¤º`);
            console.log(`ğŸ§ª æ¸¬è©¦ ${models[type]}`);
            
            setTimeout(() => {
                const accuracy = (Math.random() * 10 + 90).toFixed(1);
                const responseTime = (Math.random() * 0.5 + 0.1).toFixed(2);
                alert(`ğŸ“Š ${models[type]} æ¸¬è©¦çµæœ:\n\nâœ… æº–ç¢ºç‡: ${accuracy}%\nâš¡ éŸ¿æ‡‰æ™‚é–“: ${responseTime} ç§’\nğŸ¯ ç‹€æ…‹: æ­£å¸¸é‹è¡Œ`);
                
                if (type === 'audio') {
                    document.getElementById('audioModelAccuracy').textContent = `${accuracy}%`;
                }
            }, 5000);
        }
        
        async function startTriggeredRecording(triggerType, triggerValue) {
            if (recording) {
                console.log('âš ï¸ startTriggeredRecording: å·²ç¶“åœ¨éŒ„è£½ä¸­ï¼Œè·³é');
                return;
            }
            
            console.log(`ğŸš€ startTriggeredRecording é–‹å§‹: ${triggerType}, å€¼: ${triggerValue}`);
            
            try {
                let recordingStream;
                
                // æ ¹æ“šè¨­å®šæ±ºå®šéŒ„è£½é¡å‹
                if (detectionSettings.recordBoth) {
                    // éŒ„å½± + éŒ„éŸ³
                    console.log('ğŸ¬ è«‹æ±‚éŒ„å½±æ¬Šé™...');
                    try {
                        recordingStream = await navigator.mediaDevices.getUserMedia({ 
                            audio: true, 
                            video: {
                                width: { ideal: 1280 },
                                height: { ideal: 720 },
                                frameRate: { ideal: 30 }
                            }
                        });
                        console.log('âœ… éŒ„å½±æ¬Šé™ç²å–æˆåŠŸ');
                    } catch (videoError) {
                        console.log('âš ï¸ éŒ„å½±æ¬Šé™å¤±æ•—ï¼Œé™ç´šç‚ºåƒ…éŒ„éŸ³');
                        recordingStream = stream || await navigator.mediaDevices.getUserMedia({ audio: true });
                        // è‡¨æ™‚é—œé–‰éŒ„å½±æ¨¡å¼
                        detectionSettings.recordBoth = false;
                    }
                } else {
                    // åƒ…éŒ„éŸ³ - æŒçºŒéŒ„è£½ç›´åˆ°æ‰‹å‹•åœæ­¢æˆ–é”åˆ°æœ€å¤§æ™‚é•·
                    console.log('ğŸ¤ åƒ…éŒ„éŸ³æ¨¡å¼ - æŒçºŒéŒ„è£½');
                    recordingStream = stream || await navigator.mediaDevices.getUserMedia({ audio: true });
                }
                
                // è¨­å®šéŒ„è£½æ ¼å¼
                const options = {
                    mimeType: detectionSettings.recordBoth ? 
                        (MediaRecorder.isTypeSupported('video/webm; codecs=vp9,opus') ? 'video/webm; codecs=vp9,opus' : 'video/webm') :
                        (MediaRecorder.isTypeSupported('audio/webm; codecs=opus') ? 'audio/webm; codecs=opus' : 'audio/webm')
                };
                
                mediaRecorder = new MediaRecorder(recordingStream, options);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    saveTriggeredRecording(triggerType, triggerValue);
                    // åœæ­¢éŒ„å½±ä¸²æµ
                    if (detectionSettings.recordBoth && recordingStream !== stream) {
                        recordingStream.getTracks().forEach(track => track.stop());
                    }
                };
                
                mediaRecorder.start();
                recording = true;
                time = 0;
                interval = setInterval(updateDisplay, 1000);
                
                // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                const status = document.getElementById('status');
                status.textContent = detectionSettings.recordBoth ? 
                    `ğŸ¬ è‡ªå‹•éŒ„å½±ä¸­ (${triggerType === 'audio' ? 'éŸ³é »' : 'è¦–è¦º'}è§¸ç™¼)` :
                    `ğŸ¤ è‡ªå‹•éŒ„éŸ³ä¸­ (${triggerType === 'audio' ? 'éŸ³é »' : 'è¦–è¦º'}è§¸ç™¼)`;
                
                console.log(`âœ… è‡ªå‹•éŒ„è£½é–‹å§‹ (è§¸ç™¼: ${triggerType}, æ¨¡å¼: ${detectionSettings.recordBoth ? 'éŒ„å½±+éŒ„éŸ³' : 'åƒ…éŒ„éŸ³'})`);
                
                // å¦‚æœæ˜¯éŒ„å½±ï¼Œé¡¯ç¤ºé è¦½ï¼›å¦‚æœåƒ…éŒ„éŸ³ï¼Œé¡¯ç¤ºéŒ„éŸ³æŒ‡ç¤º
                if (detectionSettings.recordBoth) {
                    showVideoPreview(recordingStream);
                } else {
                    showAudioRecordingIndicator();
                }
                
                // è¨­ç½®è‡ªå‹•åœæ­¢éŒ„è£½è¨ˆæ™‚å™¨
                autoStopTimeout = setTimeout(() => {
                    if (recording) {
                        console.log('â° é”åˆ°æœ€é•·éŒ„è£½æ™‚é–“ï¼Œè‡ªå‹•åœæ­¢');
                        stopTriggeredRecording();
                    }
                }, detectionSettings.audioDuration * 1000);
                
            } catch (error) {
                console.error('âŒ startTriggeredRecording å¤±æ•—:', error);
                console.error('éŒ¯èª¤é¡å‹:', error.name);
                console.error('éŒ¯èª¤è¨Šæ¯:', error.message);
                
                // é¡¯ç¤ºç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤è¨Šæ¯
                const status = document.getElementById('status');
                status.textContent = `âŒ éŒ„è£½å¤±æ•—: ${error.name}`;
                
                // é™ç´šåˆ°åƒ…éŒ„éŸ³
                if (detectionSettings.recordBoth && (error.name === 'NotAllowedError' || error.name === 'NotFoundError')) {
                    console.log('âš ï¸ æ”å½±æ©Ÿæ¬Šé™è¢«æ‹’çµ•æˆ–è¨­å‚™ä¸å¯ç”¨ï¼Œé™ç´šç‚ºåƒ…éŒ„éŸ³æ¨¡å¼');
                    detectionSettings.recordBoth = false;
                    document.getElementById('recordBoth').checked = false;
                    updateRecordBoth(false);
                    
                    // é‡è©¦ç´”éŸ³é »éŒ„è£½
                    setTimeout(() => {
                        console.log('ğŸ”„ é‡è©¦ç´”éŸ³é »éŒ„è£½...');
                        startTriggeredRecording(triggerType, triggerValue);
                    }, 500);
                } else {
                    // å…¶ä»–éŒ¯èª¤ï¼Œé¡¯ç¤º3ç§’å¾Œæ¸…é™¤
                    setTimeout(() => {
                        if (audioDetectionActive) {
                            status.textContent = 'ğŸ‘ï¸ğŸµ è‡ªå‹•åµæ¸¬ä¸­';
                        }
                    }, 3000);
                }
            }
        }
        
        function stopTriggeredRecording() {
            if (!recording) return;
            
            recording = false;
            clearInterval(interval);
            
            // æ¸…é™¤è‡ªå‹•åœæ­¢è¨ˆæ™‚å™¨
            if (autoStopTimeout) {
                clearTimeout(autoStopTimeout);
                autoStopTimeout = null;
            }
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            // é‡ç½®ç‹€æ…‹é¡¯ç¤º
            const status = document.getElementById('status');
            if (audioDetectionActive) {
                status.textContent = 'ğŸ‘ï¸ğŸµ è‡ªå‹•åµæ¸¬ä¸­';
                status.style.background = '';
                status.style.transform = '';
            }
            
            console.log('â¹ï¸ è‡ªå‹•éŒ„è£½çµæŸ');
        }
        
        function showAudioRecordingIndicator() {
            // å‰µå»ºéŸ³é »éŒ„è£½æŒ‡ç¤ºå™¨
            let audioIndicator = document.getElementById('audioIndicator');
            if (!audioIndicator) {
                audioIndicator = document.createElement('div');
                audioIndicator.id = 'audioIndicator';
                audioIndicator.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    width: 200px;
                    height: 80px;
                    background: rgba(255, 75, 87, 0.9);
                    border-radius: 10px;
                    border: 2px solid #ff6b6b;
                    z-index: 1000;
                    padding: 15px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-direction: column;
                    color: white;
                    font-weight: bold;
                    animation: recordPulse 1.5s infinite;
                `;
                
                const icon = document.createElement('div');
                icon.textContent = 'ğŸ¤';
                icon.style.cssText = 'font-size: 24px; margin-bottom: 5px;';
                
                const text = document.createElement('div');
                text.textContent = 'éŒ„éŸ³ä¸­...';
                text.style.cssText = 'font-size: 14px;';
                
                audioIndicator.appendChild(icon);
                audioIndicator.appendChild(text);
                document.body.appendChild(audioIndicator);
                
                // æ·»åŠ è„ˆè¡å‹•ç•«
                if (!document.getElementById('recordPulseStyle')) {
                    const style = document.createElement('style');
                    style.id = 'recordPulseStyle';
                    style.textContent = '@keyframes recordPulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.7; transform: scale(1.05); } }';
                    document.head.appendChild(style);
                }
            }
        }
        
        function hideAudioRecordingIndicator() {
            const audioIndicator = document.getElementById('audioIndicator');
            if (audioIndicator) {
                audioIndicator.remove();
            }
        }
        
        function showVideoPreview(stream) {
            // å‰µå»ºå°å‹é è¦½çª—å£
            let previewDiv = document.getElementById('videoPreview');
            if (!previewDiv) {
                previewDiv = document.createElement('div');
                previewDiv.id = 'videoPreview';
                previewDiv.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    width: 200px;
                    height: 150px;
                    background: rgba(0,0,0,0.8);
                    border-radius: 10px;
                    border: 2px solid #ff6b6b;
                    z-index: 1000;
                    padding: 5px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                `;
                document.body.appendChild(previewDiv);
                
                const video = document.createElement('video');
                video.id = 'previewVideo';
                video.style.cssText = 'width: 100%; height: 120px; border-radius: 5px;';
                video.autoplay = true;
                video.muted = true;
                
                const label = document.createElement('div');
                label.textContent = 'ğŸ”´ éŒ„å½±ä¸­';
                label.style.cssText = 'color: #ff6b6b; font-size: 12px; margin-top: 5px; text-align: center; animation: blink 1s infinite;';
                
                previewDiv.appendChild(video);
                previewDiv.appendChild(label);
                
                // æ·»åŠ é–ƒçˆå‹•ç•«
                const style = document.createElement('style');
                style.textContent = '@keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }';
                document.head.appendChild(style);
            }
            
            const video = document.getElementById('previewVideo');
            if (video && stream) {
                video.srcObject = stream;
            }
        }
        
        function hideVideoPreview() {
            const previewDiv = document.getElementById('videoPreview');
            if (previewDiv) {
                previewDiv.remove();
            }
        }
        
        function saveTriggeredRecording(triggerType, triggerValue) {
            const isVideo = detectionSettings.recordBoth;
            const mimeType = isVideo ? 'video/webm' : 'audio/webm';
            const blob = new Blob(recordedChunks, { type: mimeType });
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const triggerText = triggerType === 'audio' ? `éŸ³é »${triggerValue}dB` : `è¦–è¦º${triggerValue.toFixed(1)}%`;
            const filePrefix = isVideo ? 'éŒ„å½±' : 'éŒ„éŸ³';
            const fileName = `${filePrefix}_${triggerText}_${timestamp.substring(11,19)}.webm`;
            
            const reader = new FileReader();
            reader.onloadend = () => {
                const fileData = {
                    id: Date.now(),
                    name: fileName,
                    type: isVideo ? 'video' : 'audio',
                    duration: time,
                    size: blob.size,
                    data: reader.result,
                    timestamp: new Date().toLocaleString('zh-TW'),
                    triggerType: `${triggerType === 'audio' ? 'ğŸµ' : 'ğŸ‘ï¸'} ${triggerText}è§¸ç™¼`,
                    autoRecorded: true,
                    isVideo: isVideo
                };
                
                recordingFiles.unshift(fileData);
                if (recordingFiles.length > 10) {
                    recordingFiles = recordingFiles.slice(0, 10);
                }
                
                localStorage.setItem('tcldcam_files', JSON.stringify(recordingFiles));
                console.log(`âœ… è‡ªå‹•${isVideo ? 'éŒ„å½±' : 'éŒ„éŸ³'}ä¿å­˜: ${fileName} (${formatFileSize(blob.size)})`);
                
                // Hide video preview or audio indicator
                if (isVideo) {
                    hideVideoPreview();
                } else {
                    hideAudioRecordingIndicator();
                }
                
                // Show notification
                showNotification(`${isVideo ? 'ğŸ¬' : 'ğŸ¤'} è‡ªå‹•${isVideo ? 'éŒ„å½±' : 'éŒ„éŸ³'}å®Œæˆ\n${fileName}\næ™‚é•·: ${formatDuration(time)}\nå¤§å°: ${formatFileSize(blob.size)}`);
            };
            reader.readAsDataURL(blob);
        }
        
        function startSimulatedDetection() {
            audioDetectionActive = true;
            visualDetectionActive = true;
            
            // æé«˜æ¨¡æ“¬è§¸ç™¼ç‡ä»¥ä¾¿æ¸¬è©¦
            const simulateDetection = () => {
                if (!audioDetectionActive) return;
                
                // æé«˜éŸ³é »åµæ¸¬æ¨¡æ“¬ç‡ï¼ˆ20% æ©Ÿç‡æ¯ 3 ç§’ï¼‰
                if (Math.random() < 0.2) {
                    const fakeVolume = Math.random() * 20 + detectionSettings.audioThreshold + 5; // è¶…éé–¾å€¼
                    console.log(`ğŸ¤– æ¨¡æ“¬éŸ³é »è§¸ç™¼: ${fakeVolume.toFixed(1)} dB (é–¾å€¼: ${detectionSettings.audioThreshold} dB)`);
                    triggerAudioDetection(Math.floor(fakeVolume));
                }
                
                // ç¸®çŸ­æ¨¡æ“¬é–“éš”åˆ° 3 ç§’
                setTimeout(simulateDetection, 3000);
            };
            
            simulateDetection();
        }
        
        function stopAutoDetection() {
            audioDetectionActive = false;
            visualDetectionActive = false;
            
            // Clean up audio context
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            // Clean up video element
            if (videoElement) {
                videoElement.srcObject?.getTracks().forEach(track => track.stop());
                videoElement.remove();
                videoElement = null;
            }
            
            // Clean up stream
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            // Stop any ongoing recording
            if (recording) {
                stopTriggeredRecording();
            }
            
            lastFrameData = null;
        }
        
        function showNotification(message) {
            // Simple alert for now (could be enhanced with custom notification UI)
            if (Notification && Notification.permission === 'granted') {
                new Notification('TCLDCAM è‡ªå‹•åµæ¸¬', {
                    body: message,
                    icon: 'ğŸ¥'
                });
            } else {
                console.log(`ğŸ“¢ é€šçŸ¥: ${message}`);
            }
        }
        
        function updateFilesList() {
            const filesGrid = document.getElementById('filesGrid');
            if (!filesGrid) return;
            
            if (recordingFiles.length === 0) {
                filesGrid.innerHTML = '<div class="card"><span class="icon">ğŸ“­</span><h4>æš«ç„¡éŒ„è£½æª”æ¡ˆ</h4><p>é–‹å§‹éŒ„è£½å¾Œæª”æ¡ˆå°‡é¡¯ç¤ºåœ¨é€™è£¡</p></div>';
                document.getElementById('fileCount').textContent = '0 å€‹';
                document.getElementById('storageInfo').textContent = '0 MB / 2 GB';
                return;
            }
            
            filesGrid.innerHTML = recordingFiles.map(file => `
                <div class="card">
                    <span class="icon">${file.isVideo ? 'ğŸ¬' : (file.type === 'audio' ? 'ğŸµ' : 'ğŸ“¹')}</span>
                    <h4>${file.name}</h4>
                    <p>${formatDuration(file.duration)} | ${formatFileSize(file.size)}</p>
                    <p style="font-size: 0.8em; opacity: 0.8;">${file.timestamp}</p>
                    <p style="font-size: 0.7em; color: #ffa500;">${file.triggerType || ''}</p>
                    <button class="btn" style="font-size: 0.8em; padding: 8px 16px;" onclick="playFile(${file.id})">${file.isVideo ? 'ğŸ¬' : 'â–¶ï¸'} æ’­æ”¾</button>
                    <button class="btn" style="font-size: 0.8em; padding: 8px 16px; background: #27ae60;" onclick="downloadFile(${file.id})">â¬‡ï¸ ä¸‹è¼‰</button>
                    <button class="btn" style="font-size: 0.8em; padding: 8px 16px; background: #ff4757;" onclick="deleteFile(${file.id})">ğŸ—‘ï¸ åˆªé™¤</button>
                </div>
            `).join('');
            
            // æ›´æ–°çµ±è¨ˆ
            const totalSize = recordingFiles.reduce((sum, file) => sum + file.size, 0);
            document.getElementById('fileCount').textContent = `${recordingFiles.length} å€‹`;
            document.getElementById('storageInfo').textContent = `${formatFileSize(totalSize)} / 2 GB`;
        }
        
        function formatDuration(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${min}:${sec.toString().padStart(2, '0')}`;
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        function playFile(id) {
            const file = recordingFiles.find(f => f.id === id);
            if (!file) return;
            
            if (file.data === 'data:audio/webm;base64,simulated') {
                alert('é€™æ˜¯æ¨¡æ“¬æª”æ¡ˆï¼Œç„¡æ³•æ’­æ”¾ã€‚è«‹å…è¨±æ¬Šé™ä»¥éŒ„è£½çœŸå¯¦åª’é«”ã€‚');
                return;
            }
            
            if (file.isVideo) {
                // æ’­æ”¾è¦–é »
                playVideoFile(file);
            } else {
                // æ’­æ”¾éŸ³é »
                const audio = new Audio(file.data);
                audio.play().then(() => {
                    console.log(`â–¶ï¸ æ’­æ”¾éŸ³é »: ${file.name}`);
                }).catch(error => {
                    console.error('éŸ³é »æ’­æ”¾å¤±æ•—:', error);
                    alert('æ’­æ”¾å¤±æ•—ï¼Œæª”æ¡ˆå¯èƒ½å·²æå£');
                });
            }
        }
        
        function playVideoFile(file) {
            // å‰µå»ºå…¨å±è¦–é »æ’­æ”¾å™¨
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.9);
                z-index: 10000;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
            `;
            
            const video = document.createElement('video');
            video.src = file.data;
            video.controls = true;
            video.autoplay = true;
            video.style.cssText = `
                max-width: 90%;
                max-height: 70%;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            const title = document.createElement('h3');
            title.textContent = file.name;
            title.style.cssText = `
                color: white;
                margin-bottom: 20px;
                text-align: center;
            `;
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'âŒ é—œé–‰';
            closeBtn.style.cssText = `
                margin-top: 20px;
                padding: 10px 20px;
                background: #ff6b6b;
                color: white;
                border: none;
                border-radius: 5px;
                font-size: 16px;
                cursor: pointer;
            `;
            
            closeBtn.onclick = () => {
                video.pause();
                overlay.remove();
            };
            
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    video.pause();
                    overlay.remove();
                }
            };
            
            overlay.appendChild(title);
            overlay.appendChild(video);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);
            
            console.log(`ğŸ¬ æ’­æ”¾è¦–é »: ${file.name}`);
        }
        
        function downloadFile(id) {
            const file = recordingFiles.find(f => f.id === id);
            if (!file) return;
            
            if (file.data === 'data:audio/webm;base64,simulated') {
                alert('é€™æ˜¯æ¨¡æ“¬æª”æ¡ˆï¼Œç„¡æ³•ä¸‹è¼‰ã€‚');
                return;
            }
            
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`â¬‡ï¸ ä¸‹è¼‰: ${file.name}`);
        }
        
        function deleteFile(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹æª”æ¡ˆå—ï¼Ÿ')) {
                recordingFiles = recordingFiles.filter(f => f.id !== id);
                localStorage.setItem('tcldcam_files', JSON.stringify(recordingFiles));
                updateFilesList();
                console.log('ğŸ—‘ï¸ æª”æ¡ˆå·²åˆªé™¤');
            }
        }
        
        function updateDisplay() {
            time++;
            const min = Math.floor(time / 60), sec = time % 60;
            document.getElementById('time').textContent = 
                `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
            document.getElementById('volume').textContent = `${Math.floor(Math.random() * 40) + 30} dB`;
            const states = ['åµæ¸¬ä¸­', 'ç™¼ç¾å‹•æ…‹', 'åˆ†æä¸­'];
            document.getElementById('visual').textContent = states[Math.floor(Math.random() * 3)];
        }
        
        // æ›´æ–°é–¾å€¼é¡¯ç¤ºå’ŒèƒŒæ™¯ç‹€æ…‹
        setInterval(() => {
            if (!recording && !audioDetectionActive) {
                document.getElementById('volume').textContent = `${Math.floor(Math.random() * 20) + 10} dB`;
                document.getElementById('debug').textContent = 'é»æ“Šé–‹å§‹åµæ¸¬æ¸¬è©¦éº¥å…‹é¢¨';
            }
            
            // å¯¦æ™‚æ›´æ–°é–¾å€¼é¡¯ç¤º
            document.getElementById('thresholdDisplay').textContent = `${detectionSettings.audioThreshold} dB`;
        }, 1000);
        
        // æ‰‹æ©Ÿç‰ˆé©é…æª¢æŸ¥
        function checkMobileCompatibility() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            console.log(`ğŸ“± è¨­å‚™æª¢æ¸¬: ${isMobile ? 'ç§»å‹•è¨­å‚™' : 'æ¡Œé¢è¨­å‚™'}`);
            if (isIOS) console.log('ğŸ iOS è¨­å‚™');
            if (isAndroid) console.log('ğŸ¤– Android è¨­å‚™');
            
            // æª¢æŸ¥é—œéµ API æ”¯æŒ
            const hasMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const hasAudioContext = !!(window.AudioContext || window.webkitAudioContext);
            const hasNotifications = !!window.Notification;
            
            console.log(`ğŸ¤ åª’é«”è¨­å‚™ API: ${hasMediaDevices ? 'âœ…' : 'âŒ'}`);
            console.log(`ğŸ”Š éŸ³é »ä¸Šä¸‹æ–‡ API: ${hasAudioContext ? 'âœ…' : 'âŒ'}`);
            console.log(`ğŸ”” é€šçŸ¥ API: ${hasNotifications ? 'âœ…' : 'âŒ'}`);
            
            // æ‰‹æ©Ÿç‰ˆç‰¹æ®Šè™•ç†
            if (isMobile) {
                // ç¦ç”¨è¦–å£ç¸®æ”¾
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
                }
                
                // iOS Safari ç‰¹æ®Šè™•ç†
                if (isIOS) {
                    // é˜²æ­¢é é¢æ»¾å‹•æ™‚åœ°å€æ¬„æ¶ˆå¤±é€ æˆçš„é«˜åº¦è®ŠåŒ–
                    document.body.style.height = '100vh';
                    document.body.style.overflow = 'hidden';
                    
                    // æ·»åŠ  iOS ç‹€æ…‹æ¬„é©é…
                    document.body.style.paddingTop = 'env(safe-area-inset-top)';
                    document.body.style.paddingBottom = 'env(safe-area-inset-bottom)';
                }
                
                // è§¸æ§åé¥‹å„ªåŒ–
                document.addEventListener('touchstart', function(){}, {passive: true});
            }
            
            return {
                isMobile,
                isIOS,
                isAndroid,
                hasMediaDevices,
                hasAudioContext,
                hasNotifications
            };
        }
        
        // æ‰‹æ©Ÿç‰ˆéŸ³é »æ¬Šé™è™•ç†
        async function requestMobilePermissions() {
            const compatibility = checkMobileCompatibility();
            
            if (compatibility.isMobile) {
                try {
                    // æ‰‹æ©Ÿç‰ˆéœ€è¦ç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼
                    console.log('ğŸ“± æ‰‹æ©Ÿç‰ˆæ¬Šé™è«‹æ±‚æº–å‚™ä¸­...');
                    
                    // å»¶é²è«‹æ±‚ï¼Œç­‰å¾…ç”¨æˆ¶äº¤äº’
                    document.addEventListener('click', async function requestOnFirstClick() {
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({ 
                                audio: true, 
                                video: false // æ‰‹æ©Ÿç‰ˆå…ˆåªè«‹æ±‚éŸ³é »æ¬Šé™
                            });
                            console.log('âœ… æ‰‹æ©Ÿç‰ˆéŸ³é »æ¬Šé™ç²å–æˆåŠŸ');
                            stream.getTracks().forEach(track => track.stop()); // ç«‹å³åœæ­¢ä»¥é‡‹æ”¾è³‡æº
                            document.removeEventListener('click', requestOnFirstClick);
                        } catch (error) {
                            console.log('âš ï¸ æ‰‹æ©Ÿç‰ˆéŸ³é »æ¬Šé™è¢«æ‹’çµ•');
                        }
                    }, { once: true });
                    
                } catch (error) {
                    console.error('æ‰‹æ©Ÿç‰ˆæ¬Šé™åˆå§‹åŒ–å¤±æ•—:', error);
                }
            }
            
            // é€šçŸ¥æ¬Šé™
            if (Notification && Notification.permission === 'default') {
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        console.log(`ğŸ”” é€šçŸ¥æ¬Šé™: ${permission}`);
                    });
                }, 2000); // å»¶é²è«‹æ±‚é¿å…å¤ªçªå…€
            }
        }
        
        // macOS éŸ³é »ä¸Šä¸‹æ–‡æ¿€æ´»
        function activateAudioContext() {
            if (audioContext && audioContext.state === 'suspended') {
                console.log('ğŸ”„ ç”¨æˆ¶æ‰‹å‹¢è§¸ç™¼ï¼Œæ¿€æ´»éŸ³é »ä¸Šä¸‹æ–‡...');
                audioContext.resume().then(() => {
                    console.log('âœ… macOS éŸ³é »ä¸Šä¸‹æ–‡æ¿€æ´»æˆåŠŸï¼');
                    document.removeEventListener('click', activateAudioContext);
                    document.removeEventListener('touchstart', activateAudioContext);
                }).catch(error => {
                    console.error('âŒ éŸ³é »ä¸Šä¸‹æ–‡æ¿€æ´»å¤±æ•—:', error);
                });
            }
        }

        // macOS ç‰¹æ®Šè™•ç†
        function handleMacOSAudio() {
            const isMacOS = navigator.platform.indexOf('Mac') > -1;
            if (isMacOS) {
                console.log('ğŸ æª¢æ¸¬åˆ° macOSï¼Œæ·»åŠ éŸ³é »æ¿€æ´»ç›£è½å™¨');
                document.addEventListener('click', activateAudioContext);
                document.addEventListener('touchstart', activateAudioContext);
                
                // é¡¯ç¤º macOS æç¤º
                setTimeout(() => {
                    if (audioContext && audioContext.state === 'suspended') {
                        alert('ğŸ macOS ç”¨æˆ¶æç¤ºï¼š\n\nç‚ºäº†å•Ÿç”¨éŸ³é »åµæ¸¬åŠŸèƒ½ï¼Œè«‹ï¼š\n1. ç¢ºä¿æ‚¨å·²å…è¨±éº¥å…‹é¢¨æ¬Šé™\n2. é»æ“Šé é¢ä»»æ„è™•æ¿€æ´»éŸ³é »\n3. æª¢æŸ¥ Safari è¨­å®šä¸­çš„éº¥å…‹é¢¨æ¬Šé™');
                    }
                }, 3000);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkMobileCompatibility();
            requestMobilePermissions();
            handleMacOSAudio();
            console.log('ğŸ“± æ‰‹æ©Ÿç‰ˆé©é…åˆå§‹åŒ–å®Œæˆ');
            console.log('ğŸ macOS ç›¸å®¹æ€§æª¢æŸ¥å®Œæˆ');
        });
        
        console.log('ğŸš€ TCLDCAM v1.1.7 - ä¿®å¾©ç›£è½å¾ªç’°åœæ­¢å•é¡Œç‰ˆæœ¬');
        console.log('âœ¨ åŠŸèƒ½åˆ—è¡¨:');
        console.log('   ğŸµ çœŸå¯¦ dB éŸ³é‡æ¸¬é‡ (RMS + å°æ•¸è½‰æ›)');
        console.log('   ğŸ¯ ç·šæ€§éŸ³é‡è§¸ç™¼ç³»çµ± (5-80 ç¯„åœ)');
        console.log('   ğŸ¬ è‡ªå‹•éŒ„å½± + éŒ„éŸ³åŒæ­¥');
        console.log('   ğŸ“± æ‰‹æ©Ÿ/æ¡Œé¢ RWD é©é…');
        console.log('ğŸ”Š ä½¿ç”¨èªªæ˜:');
        console.log('   1. é»æ“Š"ğŸ¬ é–‹å§‹éŒ„å½±åµæ¸¬"ä¸¦å…è¨±æ¬Šé™');
        console.log('   2. æª¢æŸ¥ä¸»é "å¯¦æ™‚"æ¬„ä½ RMS ç™¾åˆ†æ¯”');
        console.log('   3. åœ¨è¨­å®šä¸­èª¿æ•´é–¾å€¼ (20-35 å»ºè­°ç¯„åœ)');
        console.log('   4. å°è‘—éº¥å…‹é¢¨èªªè©±æ¸¬è©¦è§¸ç™¼åŠŸèƒ½');
    </script>
</body>
</html>